---
phase: 11.1-queued-response-sample
plan: 01
subsystem: ui
tags: [unity, ui-toolkit, state-machine, audio-buffering, push-to-talk, uxml, uss]

# Dependency graph
requires:
  - phase: 11-integration-verification
    provides: PersonaSession event API, AudioPlayback, SyncPacket, AyaLiveStream sample pattern
provides:
  - QueuedResponseController with 5-state machine and audio buffering
  - QueuedResponseUI with state-driven UI Toolkit bindings
  - Complete UXML/USS layout matching Aya dark theme conventions
  - Assembly definition for QueuedResponseSample
affects: [11.1-02 scene setup, future sample scenes]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Null-AudioPlayback decoupling: PersonaSession._audioPlayback left null, audio collected from OnSyncPacket"
    - "Audio buffer pattern: List<float[]> during Reviewing, bulk feed to AudioPlayback on approval"
    - "Playback completion via _turnComplete && !_audioPlayback.IsPlaying (not OnAISpeakingStopped)"

key-files:
  created:
    - Assets/QueuedResponseSample/QueuedResponseSample.asmdef
    - Assets/QueuedResponseSample/QueuedResponseController.cs
    - Assets/QueuedResponseSample/QueuedResponseUI.cs
    - Assets/QueuedResponseSample/UI/QueuedResponsePanel.uxml
    - Assets/QueuedResponseSample/UI/QueuedResponsePanel.uss
  modified: []

key-decisions:
  - "QueuedState enum defined in QueuedResponseController.cs file (not separate file) -- co-located with primary consumer"
  - "EnsurePlaybackInitialized guard pattern instead of eager initialization in Start -- lazy init on first approval"
  - "indicator--speaking class reused from Aya USS for Playing state green glow"
  - "response-ready class added for pulsing green indicator when AI turn completes during Reviewing"
  - "recording class added for red glow during Recording state"

patterns-established:
  - "Queued response state machine: Connecting -> Idle -> Recording -> Reviewing -> Playing -> Idle"
  - "Audio buffer-then-drain: collect SyncPacket audio during Reviewing, feed to AudioPlayback on Enter"

# Metrics
duration: 2min
completed: 2026-02-13
---

# Phase 11.1 Plan 01: Queued Response Sample Summary

**5-state push-to-talk controller with audio buffering, UI Toolkit two-panel transcript layout, and dark theme USS matching Aya conventions**

## Performance

- **Duration:** 2 min
- **Started:** 2026-02-14T02:03:02Z
- **Completed:** 2026-02-14T02:05:15Z
- **Tasks:** 3
- **Files modified:** 12 (8 Task 1 + 2 Task 2 + 2 Task 3)

## Accomplishments
- Complete 5-state machine (Connecting/Idle/Recording/Reviewing/Playing) with keyboard-driven transitions
- Audio buffering during Reviewing state with bulk feed to AudioPlayback on user approval
- Live streaming fallback when AI is still generating during Playing state
- Two-panel UXML layout with user transcript and AI response areas
- State-driven UI with status text, key hints, and indicator class management

## Task Commits

Each task was committed atomically:

1. **Task 1: Create project structure and UI assets** - `9b16a6f` (feat)
2. **Task 2: Create QueuedResponseController with state machine and audio buffering** - `24e19b9` (feat)
3. **Task 3: Create QueuedResponseUI with state-driven display** - `b024f10` (feat)

## Files Created/Modified
- `Assets/QueuedResponseSample.meta` - Folder metadata
- `Assets/QueuedResponseSample/UI.meta` - UI subfolder metadata
- `Assets/QueuedResponseSample/QueuedResponseSample.asmdef` - Assembly definition referencing ai-embodiment and InputSystem
- `Assets/QueuedResponseSample/QueuedResponseSample.asmdef.meta` - Assembly definition metadata
- `Assets/QueuedResponseSample/QueuedResponseController.cs` - 5-state machine controller with audio buffering (210 lines)
- `Assets/QueuedResponseSample/QueuedResponseController.cs.meta` - Controller script metadata
- `Assets/QueuedResponseSample/QueuedResponseUI.cs` - UI Toolkit bindings with state-driven display (117 lines)
- `Assets/QueuedResponseSample/QueuedResponseUI.cs.meta` - UI script metadata
- `Assets/QueuedResponseSample/UI/QueuedResponsePanel.uxml` - Two-panel transcript layout with 5 required elements
- `Assets/QueuedResponseSample/UI/QueuedResponsePanel.uxml.meta` - UXML metadata
- `Assets/QueuedResponseSample/UI/QueuedResponsePanel.uss` - Dark theme with recording/response-ready/speaking indicator classes
- `Assets/QueuedResponseSample/UI/QueuedResponsePanel.uss.meta` - USS metadata

## Decisions Made
- QueuedState enum co-located in QueuedResponseController.cs (same namespace, no separate file needed)
- Lazy AudioPlayback initialization via EnsurePlaybackInitialized guard (avoids dummy clip creation until first approval)
- Reused indicator--speaking class from Aya USS for Playing state
- Added recording (red) and response-ready (green) indicator classes for state visualization
- SetStatus escape hatch on QueuedResponseUI for direct error messages outside normal state flow

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness
- All scripts and UI assets are ready for scene assembly
- Scene file (QueuedResponseScene.unity) needs to be created in Unity Editor with correct component wiring
- PersonaSession._audioPlayback must be left null in scene; QueuedResponseController._audioPlayback wired to separate AudioPlayback GO

---
*Phase: 11.1-queued-response-sample*
*Completed: 2026-02-13*
