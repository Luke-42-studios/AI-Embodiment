---
phase: 09-tts-abstraction
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Packages/com.google.ai-embodiment/Runtime/ITTSProvider.cs
  - Packages/com.google.ai-embodiment/Runtime/VoiceBackend.cs
  - Packages/com.google.ai-embodiment/Runtime/ChirpTTSClient.cs
  - Packages/com.google.ai-embodiment/Runtime/PersonaConfig.cs
autonomous: true

must_haves:
  truths:
    - "ITTSProvider interface exists with SynthesizeAsync returning Awaitable<TTSResult>"
    - "ChirpTTSClient implements ITTSProvider with Newtonsoft.Json serialization"
    - "VoiceBackend enum has three values: GeminiNative, ChirpTTS, Custom"
    - "PersonaConfig exposes synthesisMode (TTSSynthesisMode) and CustomTTSProvider property"
  artifacts:
    - path: "Packages/com.google.ai-embodiment/Runtime/ITTSProvider.cs"
      provides: "ITTSProvider interface, TTSResult struct, TTSSynthesisMode enum"
      contains: "interface ITTSProvider"
    - path: "Packages/com.google.ai-embodiment/Runtime/VoiceBackend.cs"
      provides: "Three-value VoiceBackend enum"
      contains: "Custom"
    - path: "Packages/com.google.ai-embodiment/Runtime/ChirpTTSClient.cs"
      provides: "ITTSProvider implementation for Cloud TTS"
      contains: "class ChirpTTSClient : IDisposable, ITTSProvider"
    - path: "Packages/com.google.ai-embodiment/Runtime/PersonaConfig.cs"
      provides: "Updated config with TTSSynthesisMode and custom provider slot"
      contains: "TTSSynthesisMode"
  key_links:
    - from: "Packages/com.google.ai-embodiment/Runtime/ChirpTTSClient.cs"
      to: "ITTSProvider"
      via: "interface implementation"
      pattern: "class ChirpTTSClient.*ITTSProvider"
    - from: "Packages/com.google.ai-embodiment/Runtime/PersonaConfig.cs"
      to: "ITTSProvider"
      via: "CustomTTSProvider property cast"
      pattern: "_customTTSProvider as ITTSProvider"
---

<objective>
Create the ITTSProvider interface, TTSResult struct, and TTSSynthesisMode enum. Refactor ChirpTTSClient to implement ITTSProvider with the new signature. Extend VoiceBackend with Custom value. Update PersonaConfig with provider-agnostic synthesis mode and custom provider slot.

Purpose: Establish the abstraction layer that decouples PersonaSession from any specific TTS implementation, enabling third-party TTS backends.
Output: Four modified/created files providing the complete type foundation for TTS abstraction.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-tts-abstraction/09-CONTEXT.md
@.planning/phases/09-tts-abstraction/09-RESEARCH.md

# Source files to modify
@Packages/com.google.ai-embodiment/Runtime/ChirpTTSClient.cs
@Packages/com.google.ai-embodiment/Runtime/VoiceBackend.cs
@Packages/com.google.ai-embodiment/Runtime/PersonaConfig.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ITTSProvider interface, TTSResult struct, TTSSynthesisMode enum, and extend VoiceBackend</name>
  <files>
    Packages/com.google.ai-embodiment/Runtime/ITTSProvider.cs
    Packages/com.google.ai-embodiment/Runtime/VoiceBackend.cs
  </files>
  <action>
Create a new file `ITTSProvider.cs` in the Runtime directory containing three types in the `AIEmbodiment` namespace:

1. **ITTSProvider interface** extending IDisposable:
   - Single method: `Awaitable<TTSResult> SynthesizeAsync(string text, string voiceName, string languageCode, Action<TTSResult> onAudioChunk = null)`
   - XML doc comments explaining: text is what to synthesize, voiceName is provider-specific, languageCode is BCP-47, onAudioChunk is optional streaming callback (unused by REST providers, forward-compatible slot)
   - Class-level doc: "Abstraction for text-to-speech synthesis backends. Implementations must be safe to call from the Unity main thread."

2. **TTSResult readonly struct**:
   - Fields: `readonly float[] Samples`, `readonly int SampleRate`, `readonly int Channels`
   - Constructor taking all three
   - Property: `bool HasAudio => Samples != null && Samples.Length > 0`
   - XML doc comments on each field

3. **TTSSynthesisMode enum** (replaces ChirpSynthesisMode):
   - Values: `SentenceBySentence`, `FullResponse`
   - XML doc comments matching existing ChirpSynthesisMode descriptions but provider-agnostic ("Synthesize each sentence as PacketAssembler emits it" / "Wait for complete AI response, synthesize once")
   - Class-level doc: "Controls how TTS providers synthesize audio from AI text output. Provider-agnostic replacement for ChirpSynthesisMode."

Required usings: `System` (for Action and IDisposable), `UnityEngine` (for Awaitable).

Then modify `VoiceBackend.cs`: Add `Custom` as the third enum value with XML doc: "Routes text to a developer-supplied ITTSProvider MonoBehaviour."
  </action>
  <verify>
Grep for `interface ITTSProvider` in ITTSProvider.cs -- must exist.
Grep for `readonly struct TTSResult` in ITTSProvider.cs -- must exist.
Grep for `enum TTSSynthesisMode` in ITTSProvider.cs -- must exist.
Grep for `Custom` in VoiceBackend.cs -- must exist with three total enum values.
  </verify>
  <done>
ITTSProvider.cs contains the interface, struct, and enum. VoiceBackend.cs has GeminiNative, ChirpTTS, Custom.
  </done>
</task>

<task type="auto">
  <name>Task 2: Refactor ChirpTTSClient to implement ITTSProvider and update PersonaConfig</name>
  <files>
    Packages/com.google.ai-embodiment/Runtime/ChirpTTSClient.cs
    Packages/com.google.ai-embodiment/Runtime/PersonaConfig.cs
  </files>
  <action>
**ChirpTTSClient.cs changes:**

1. Change class declaration to: `public class ChirpTTSClient : IDisposable, ITTSProvider`

2. Add `_voiceCloningKey` field: `private readonly string _voiceCloningKey;`

3. Change constructor to accept voiceCloningKey:
   ```
   public ChirpTTSClient(string apiKey, string voiceCloningKey = null)
   ```
   Store `_voiceCloningKey = voiceCloningKey;` in the constructor body.

4. Change SynthesizeAsync signature from:
   ```
   public async Awaitable<float[]> SynthesizeAsync(string text, string voiceName, string languageCode, string voiceCloningKey = null)
   ```
   To:
   ```
   public async Awaitable<TTSResult> SynthesizeAsync(string text, string voiceName, string languageCode, Action<TTSResult> onAudioChunk = null)
   ```
   - Replace the `voiceCloningKey` parameter usage inside the method with `_voiceCloningKey` field
   - Change the BuildRequestJson call to use `_voiceCloningKey` instead of the parameter
   - Change the return from `return ConvertLinear16ToFloat(audioBytes);` to `return new TTSResult(ConvertLinear16ToFloat(audioBytes), SAMPLE_RATE, 1);`
   - Change the null return (disposed check after await) from `return null;` to `return default;`
   - The `onAudioChunk` parameter is accepted but NOT used (REST is non-streaming; document this in XML doc)

5. **Remove the `OnError` event entirely.** Per CONTEXT.md decision: "Errors are exceptions from SynthesizeAsync -- no OnError event on the interface." The method already throws exceptions; PersonaSession's try/catch in SynthesizeAndEnqueue handles error routing. Remove `public event Action<Exception> OnError;` and both `OnError?.Invoke(ex);` lines (the exceptions are still thrown after removal of OnError invocations).

6. Update the BuildRequestJson method: change `string voiceCloningKey` parameter to use `_voiceCloningKey` field. Since BuildRequestJson is static, either:
   - Make it non-static and access `_voiceCloningKey` directly, OR
   - Keep it static and pass `_voiceCloningKey` from the caller (preferred -- keep static for testability)
   Keep passing it from the caller is simplest -- the call in SynthesizeAsync changes from `BuildRequestJson(text, voiceName, languageCode, voiceCloningKey)` to `BuildRequestJson(text, voiceName, languageCode, _voiceCloningKey)`.

7. Update XML doc comments to reflect ITTSProvider interface, TTSResult return type, and the fact that onAudioChunk is ignored (REST non-streaming).

**PersonaConfig.cs changes:**

1. Replace `ChirpSynthesisMode chirpSynthesisMode` with `TTSSynthesisMode synthesisMode`:
   ```
   public TTSSynthesisMode synthesisMode = TTSSynthesisMode.SentenceBySentence;
   ```

2. Delete the `ChirpSynthesisMode` enum definition from the bottom of PersonaConfig.cs (it is replaced by TTSSynthesisMode in ITTSProvider.cs).

3. Add custom provider field and property:
   ```
   [SerializeField] private MonoBehaviour _customTTSProvider;

   /// <summary>
   /// Returns the custom TTS provider if assigned and valid (implements ITTSProvider).
   /// Null otherwise.
   /// </summary>
   public ITTSProvider CustomTTSProvider => _customTTSProvider as ITTSProvider;
   ```
   Place the field in the Voice section (after voiceCloningKey) and the property after IsCustomChirpVoice.

Important: Do NOT change the `using` statements in ChirpTTSClient.cs -- `System` is already imported (needed for Action<>). If not present, add `using System;`.
  </action>
  <verify>
Grep for `class ChirpTTSClient : IDisposable, ITTSProvider` -- confirms interface implementation.
Grep for `Awaitable<TTSResult>` in ChirpTTSClient.cs -- confirms return type change.
Grep for `OnError` in ChirpTTSClient.cs -- must return zero matches (event removed).
Grep for `voiceCloningKey = null` in ChirpTTSClient constructor -- confirms constructor parameter.
Grep for `ChirpSynthesisMode` across all Runtime .cs files -- must return zero matches (fully replaced by TTSSynthesisMode).
Grep for `synthesisMode` in PersonaConfig.cs -- confirms rename.
Grep for `_customTTSProvider` in PersonaConfig.cs -- confirms custom provider field.
Grep for `CustomTTSProvider` in PersonaConfig.cs -- confirms property.
  </verify>
  <done>
ChirpTTSClient implements ITTSProvider, returns TTSResult, takes voiceCloningKey in constructor, OnError event removed. PersonaConfig uses TTSSynthesisMode, has custom provider slot. Zero references to ChirpSynthesisMode remain in Runtime.
  </done>
</task>

</tasks>

<verification>
1. `grep -r "ChirpSynthesisMode" Packages/com.google.ai-embodiment/Runtime/` returns zero matches
2. `grep -r "interface ITTSProvider" Packages/com.google.ai-embodiment/Runtime/` returns ITTSProvider.cs
3. `grep -r "ITTSProvider" Packages/com.google.ai-embodiment/Runtime/ChirpTTSClient.cs` confirms implementation
4. `grep -r "OnError" Packages/com.google.ai-embodiment/Runtime/ChirpTTSClient.cs` returns zero matches
5. `grep "Custom" Packages/com.google.ai-embodiment/Runtime/VoiceBackend.cs` shows third enum value
</verification>

<success_criteria>
- ITTSProvider.cs exists with interface, TTSResult struct, TTSSynthesisMode enum
- ChirpTTSClient implements ITTSProvider, returns TTSResult, no OnError event
- VoiceBackend has three values (GeminiNative, ChirpTTS, Custom)
- PersonaConfig uses TTSSynthesisMode and has CustomTTSProvider property
- Zero ChirpSynthesisMode references remain in Runtime code
</success_criteria>

<output>
After completion, create `.planning/phases/09-tts-abstraction/09-01-SUMMARY.md`
</output>
