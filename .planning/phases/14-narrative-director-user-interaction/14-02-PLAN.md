---
phase: 14-narrative-director-user-interaction
plan: 02
type: execute
wave: 2
depends_on: ["14-01"]
files_modified:
  - Assets/AyaLiveStream/NarrativeDirector.cs
  - Assets/AyaLiveStream/ChatBotManager.cs
autonomous: true

must_haves:
  truths:
    - "NarrativeDirector progresses through 3 beats driven by time budget with early-exit on goal-met"
    - "SendText director notes fire at beat transitions and trigger Aya to naturally shift topic"
    - "Director notes never fire while Aya is speaking -- queued for next OnTurnComplete"
    - "GoalUrgency escalates across beats (Low -> Medium -> High) and is accessible for pacing decisions"
    - "ChatBotManager slows burst timing when Aya is speaking (2x min lull, 1.5x max lull, half bot count)"
    - "ChatBotManager pauses at beat transitions and resumes after director note response"
    - "NarrativeDirector exposes IsAyaSpeaking and OnBeatTransition for external subscribers"
  artifacts:
    - path: "Assets/AyaLiveStream/NarrativeDirector.cs"
      provides: "Beat lifecycle loop, SendText steering, dual-queue coordination events, IsAyaSpeaking flag, urgency-aware pacing"
      exports: ["NarrativeDirector"]
      min_lines: 100
    - path: "Assets/AyaLiveStream/ChatBotManager.cs"
      provides: "Modified burst loop with NarrativeDirector pacing integration"
      contains: "_narrativeDirector"
  key_links:
    - from: "NarrativeDirector.cs"
      to: "PersonaSession.SendText"
      via: "director note at beat transition"
      pattern: "_session\\.SendText"
    - from: "NarrativeDirector.cs"
      to: "PersonaSession.OnAISpeakingStarted/Stopped"
      via: "event subscription for IsAyaSpeaking tracking"
      pattern: "OnAISpeakingStarted|OnAISpeakingStopped"
    - from: "NarrativeDirector.cs"
      to: "PersonaSession.OnTurnComplete"
      via: "event subscription for safe director note sending"
      pattern: "OnTurnComplete"
    - from: "NarrativeDirector.cs"
      to: "NarrativeBeatConfig.urgency"
      via: "urgency-aware beat pacing"
      pattern: "beat\\.urgency|CurrentBeat\\.urgency"
    - from: "ChatBotManager.cs"
      to: "NarrativeDirector.IsAyaSpeaking"
      via: "burst pacing check"
      pattern: "_narrativeDirector.*IsAyaSpeaking"
---

<objective>
Create NarrativeDirector MonoBehaviour with time-based beat lifecycle, SendText director note steering, urgency-aware pacing, and dual-queue coordination events. Modify ChatBotManager to integrate pacing control (slower bursts when Aya speaks, pause at beat transitions).

Purpose: This is the core orchestrator for the narrative arc. It drives beat progression, steers Aya via SendText, exposes GoalUrgency for pacing decisions, and provides coordination signals for all other systems. The PTT controller (14-04) and scene execution (14-03) both depend on this foundation.

Output: NarrativeDirector.cs with beat loop + events + urgency access, modified ChatBotManager.cs with pacing integration.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-narrative-director-user-interaction/14-CONTEXT.md
@.planning/phases/14-narrative-director-user-interaction/14-RESEARCH.md
@.planning/phases/14-narrative-director-user-interaction/14-01-SUMMARY.md
@Assets/AyaLiveStream/NarrativeBeatConfig.cs
@Assets/AyaLiveStream/ChatBotManager.cs
@Assets/AyaLiveStream/LivestreamUI.cs
@Packages/com.google.ai-embodiment/Runtime/PersonaSession.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create NarrativeDirector with beat lifecycle and SendText steering</name>
  <files>Assets/AyaLiveStream/NarrativeDirector.cs</files>
  <action>
Create NarrativeDirector.cs in the AIEmbodiment.Samples namespace as a MonoBehaviour with these responsibilities:

**Serialized fields:**
- `[SerializeField] PersonaSession _session`
- `[SerializeField] NarrativeBeatConfig[] _beats` -- drag beat assets here in Inspector
- `[SerializeField] LivestreamUI _livestreamUI` -- for Aya speaking indicator

**Public API (for other systems to consume):**
- `bool IsAyaSpeaking { get; private set; }` -- true between OnAISpeakingStarted and OnAISpeakingStopped
- `NarrativeBeatConfig CurrentBeat` -- the currently active beat (null before start / after end)
- `int CurrentBeatIndex` -- index into _beats array (-1 if not started)
- `event Action<NarrativeBeatConfig> OnBeatStarted` -- fires when a beat begins
- `event Action<NarrativeBeatConfig> OnBeatEnded` -- fires when a beat completes
- `event Action OnBeatTransition` -- fires between beats for sync point (ChatBotManager subscribes)
- `event Action OnAllBeatsComplete` -- fires when narrative arc is finished (Phase 15/16 listens for reveal trigger)
- `void StartNarrative()` -- called by AyaSampleController when session connects, kicks off RunBeatLoop
- `void MarkGoalMet()` -- external signal that the current beat's goal is met (for skip detection and future use)

**Private state:**
- `bool _isAyaSpeaking` -- backing field for IsAyaSpeaking
- `bool _beatGoalMet` -- set true by MarkGoalMet or skip detection
- `int _currentBeatIndex = -1`
- `NarrativeBeatConfig _pendingBeatTransition` -- queued beat if transition triggers while Aya is speaking
- `bool _narrativeRunning`

**Event subscriptions (in StartNarrative, unsubscribe in OnDestroy):**
- `_session.OnAISpeakingStarted += () => { _isAyaSpeaking = true; _livestreamUI?.SetAyaSpeaking(true); }`
- `_session.OnAISpeakingStopped += () => { _isAyaSpeaking = false; _livestreamUI?.SetAyaSpeaking(false); }`
- `_session.OnTurnComplete += HandleTurnComplete`
- `_session.OnInputTranscription += CheckSkipKeywords`

**StartNarrative():**
CRITICAL: Set `_narrativeRunning = true` at the start of this method, before subscribing to events and before calling RunBeatLoop. This flag gates the beat timer loop and must be true for beats to progress.
```csharp
public void StartNarrative()
{
    _narrativeRunning = true;
    // Subscribe to events...
    // Kick off RunBeatLoop...
}
```

**HandleTurnComplete:**
If `_pendingBeatTransition != null`, call `ExecuteBeatTransition(_pendingBeatTransition)` and clear the pending.

**CheckSkipKeywords(string transcript):**
If the current beat has skipKeywords AND we are NOT on the last beat: check if any skipKeyword appears in the transcript (case-insensitive Contains). If match found, set `_beatGoalMet = true` to trigger early exit from current beat, AND mark all remaining beats as skipped except the last one (set `_currentBeatIndex` to `_beats.Length - 2` so the loop advances to the final beat).

**RunBeatLoop (async Awaitable):**
```
try {
    for (int i = 0; i < _beats.Length; i++) {
        _currentBeatIndex = i;
        _beatGoalMet = false;
        var beat = _beats[i];

        // Fire beat transition event (sync point)
        if (i > 0) OnBeatTransition?.Invoke();

        // Wait for Aya to finish current turn before sending director note
        // (CRITICAL: Pitfall 3 from research -- never send while Aya speaks)
        if (_isAyaSpeaking) {
            _pendingBeatTransition = beat;
            // Wait for HandleTurnComplete to call ExecuteBeatTransition
            while (_pendingBeatTransition != null) {
                await Awaitable.WaitForSecondsAsync(0.1f, destroyCancellationToken);
            }
        } else {
            ExecuteBeatTransition(beat);
        }

        // Beat timer loop: advance on goal-met or time-expired
        float elapsed = 0f;
        while (elapsed < beat.timeBudgetSeconds && !_beatGoalMet) {
            await Awaitable.WaitForSecondsAsync(1f, destroyCancellationToken);
            elapsed += 1f;
            if (!_narrativeRunning) return;
        }

        OnBeatEnded?.Invoke(beat);
    }

    OnAllBeatsComplete?.Invoke();
}
catch (OperationCanceledException) { }
```

**ExecuteBeatTransition(NarrativeBeatConfig beat):**
```
_pendingBeatTransition = null;
CurrentBeat = beat;
OnBeatStarted?.Invoke(beat);

if (!string.IsNullOrEmpty(beat.directorNote)) {
    _session.SendText(beat.directorNote);
}
```

**OnDestroy:**
Unsubscribe all events from _session (null-check _session first). Set `_narrativeRunning = false`.

CRITICAL ANTI-PATTERNS TO AVOID (from 14-RESEARCH.md):
- NEVER use GoalManager for mid-session steering (goals only apply at next Connect())
- NEVER send SendText while Aya is speaking (triggers interruption, clears audio buffer)
- NEVER block the main thread -- all timing uses Awaitable
- NEVER manipulate ChatBotManager._running directly -- use events only

Follow the async Awaitable pattern established by ChatBotManager.ScriptedBurstLoop: try/catch OperationCanceledException, use destroyCancellationToken.
  </action>
  <verify>
NarrativeDirector.cs compiles. Verify: has StartNarrative() that sets _narrativeRunning = true, RunBeatLoop(), IsAyaSpeaking property, OnBeatTransition event, SendText call guarded by _isAyaSpeaking check, CheckSkipKeywords method, and OnDestroy cleanup.
  </verify>
  <done>NarrativeDirector drives beat progression with time + goal, sends director notes safely (never while Aya speaks), exposes IsAyaSpeaking, CurrentBeat (with urgency), and beat events for downstream systems. StartNarrative explicitly sets _narrativeRunning = true before entering the beat loop.</done>
</task>

<task type="auto">
  <name>Task 2: Add NarrativeDirector pacing integration to ChatBotManager</name>
  <files>Assets/AyaLiveStream/ChatBotManager.cs</files>
  <action>
Modify ChatBotManager.cs to integrate with NarrativeDirector for burst pacing. Read the existing file first.

**Add serialized field:**
```csharp
[Header("Narrative Pacing")]
[SerializeField] private NarrativeDirector _narrativeDirector;
```

**Add beat transition pause state:**
```csharp
private bool _pausedForTransition;
```

**In StartBursts(), subscribe to beat transition if _narrativeDirector is assigned:**
```csharp
if (_narrativeDirector != null)
{
    _narrativeDirector.OnBeatTransition += HandleBeatTransition;
}
```

**In StopBursts() and OnDestroy(), unsubscribe:**
```csharp
if (_narrativeDirector != null)
{
    _narrativeDirector.OnBeatTransition -= HandleBeatTransition;
}
```

**Add HandleBeatTransition:**
```csharp
private void HandleBeatTransition()
{
    _pausedForTransition = true;
    // Resume after a brief pause to let director note response settle
    _ = ResumeAfterTransition();
}

private async Awaitable ResumeAfterTransition()
{
    try
    {
        // Wait for director note to trigger Aya's response and complete
        await Awaitable.WaitForSecondsAsync(5f, destroyCancellationToken);
        _pausedForTransition = false;
    }
    catch (OperationCanceledException) { }
}
```

**Modify ScriptedBurstLoop to use pacing-aware timing:**

Replace the hardcoded lull duration calculation with a pacing-aware version:

```csharp
// Inside ScriptedBurstLoop, replace the lull duration line:
float lullDuration = UnityEngine.Random.Range(_burstIntervalMin, _burstIntervalMax);

// With:
float lullDuration = GetBurstLullDuration();

// And replace the botCount line:
int botCount = UnityEngine.Random.Range(1, Mathf.Min(_maxBotsPerBurst, _bots.Length) + 1);

// With:
int botCount = UnityEngine.Random.Range(1, Mathf.Min(GetMaxBotsForBurst(), _bots.Length) + 1);
```

**Add the pacing helper methods (per 14-RESEARCH.md Pattern 2):**
```csharp
private float GetBurstLullDuration()
{
    bool ayaSpeaking = _narrativeDirector != null && _narrativeDirector.IsAyaSpeaking;
    float min = ayaSpeaking ? _burstIntervalMin * 2f : _burstIntervalMin;
    float max = ayaSpeaking ? _burstIntervalMax * 1.5f : _burstIntervalMax;
    return UnityEngine.Random.Range(min, max);
}

private int GetMaxBotsForBurst()
{
    bool ayaSpeaking = _narrativeDirector != null && _narrativeDirector.IsAyaSpeaking;
    return ayaSpeaking ? Mathf.Max(1, _maxBotsPerBurst / 2) : _maxBotsPerBurst;
}
```

**Add beat-transition pause check in ScriptedBurstLoop:**
After the lull duration await and before posting messages, add:
```csharp
// Pause during beat transitions (Pitfall 7: stale-context bursts)
while (_pausedForTransition)
{
    await Awaitable.WaitForSecondsAsync(0.5f, destroyCancellationToken);
}
```

Do NOT change any existing public API, method signatures, or the dynamic response system. Only add the pacing layer on top of the existing burst loop.
  </action>
  <verify>
ChatBotManager.cs compiles. Verify: has `_narrativeDirector` field, `GetBurstLullDuration()` method, `GetMaxBotsForBurst()` method, `_pausedForTransition` flag, `HandleBeatTransition()` subscription, and `ResumeAfterTransition()`. The existing ScriptedBurstLoop uses the new helper methods instead of hardcoded values.
  </verify>
  <done>ChatBotManager slows burst timing when Aya is speaking (2x min, 1.5x max, half bots) and pauses during beat transitions. All changes are additive -- existing API preserved.</done>
</task>

</tasks>

<verification>
1. NarrativeDirector.cs compiles in AIEmbodiment.Samples namespace
2. StartNarrative() sets _narrativeRunning = true before subscribing to events and entering beat loop
3. Beat loop progresses through _beats array with time-based advancement
4. SendText fires ONLY after checking !_isAyaSpeaking (pending queue if Aya speaking)
5. OnBeatTransition event fires between beats for sync
6. CurrentBeat exposes the active NarrativeBeatConfig including its urgency field
7. ChatBotManager integrates NarrativeDirector pacing without breaking existing burst/dynamic response APIs
8. Skip keyword detection works via OnInputTranscription subscription
9. All async methods use destroyCancellationToken and try/catch OperationCanceledException
10. OnDestroy properly unsubscribes all events
</verification>

<success_criteria>
- NarrativeDirector can drive 3-beat progression with time budgets and early-exit on goal-met
- Director notes steer Aya naturally at beat transitions (never while she speaks)
- GoalUrgency is accessible via CurrentBeat.urgency for downstream pacing decisions (Low -> Medium -> High across the arc)
- ChatBotManager pacing responds to Aya's speaking state in real-time
- Beat transition sync points prevent stale-context chat bursts
- IsAyaSpeaking and events are available for 14-03 (scene execution) and 14-04 (PTT controller)
</success_criteria>

<output>
After completion, create `.planning/phases/14-narrative-director-user-interaction/14-02-SUMMARY.md`
</output>
</output>
