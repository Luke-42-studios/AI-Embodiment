---
phase: 11-integration-verification
plan: 02
type: execute
wave: 2
depends_on: ["11-01"]
files_modified:
  - Assets/AyaLiveStream/AyaSampleController.cs
  - Packages/com.google.ai-embodiment/Samples~/AyaLiveStream/AyaSampleController.cs
autonomous: false

must_haves:
  truths:
    - "AyaSampleController subscribes to OnStateChanged and surfaces connection status via AyaChatUI"
    - "AyaSampleController subscribes to OnSyncPacket and logs packet metadata for validation"
    - "Samples~ AyaSampleController is identical to Assets/ copy"
    - "Sample scene connects, shows status feedback, and produces SyncPackets with both voice backends"
  artifacts:
    - path: "Assets/AyaLiveStream/AyaSampleController.cs"
      provides: "Updated sample controller with status feedback and SyncPacket logging"
      contains: "OnStateChanged"
    - path: "Assets/AyaLiveStream/AyaSampleController.cs"
      provides: "SyncPacket validation logging"
      contains: "OnSyncPacket"
    - path: "Packages/com.google.ai-embodiment/Samples~/AyaLiveStream/AyaSampleController.cs"
      provides: "Canonical sample copy identical to Assets/"
      contains: "OnSyncPacket"
  key_links:
    - from: "Assets/AyaLiveStream/AyaSampleController.cs"
      to: "PersonaSession.OnStateChanged"
      via: "event subscription in Start()"
      pattern: "OnStateChanged \\+="
    - from: "Assets/AyaLiveStream/AyaSampleController.cs"
      to: "PersonaSession.OnSyncPacket"
      via: "event subscription in Start()"
      pattern: "OnSyncPacket \\+="
---

<objective>
Add connection status feedback and SyncPacket validation logging to AyaSampleController, synchronize the Samples~ canonical copy, and verify the complete end-to-end flow in the sample scene.

Purpose: The sample scene must demonstrate the full API surface and provide observable validation that PacketAssembler produces correct SyncPackets with both voice backends (Gemini Native and Chirp TTS). Connection status feedback gives developers visibility into the session lifecycle.

Output: Updated AyaSampleController with status/validation wiring, synced Samples~ copy, and human-verified end-to-end flow.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-integration-verification/11-RESEARCH.md
@.planning/phases/11-integration-verification/11-01-SUMMARY.md

Key files:
@Assets/AyaLiveStream/AyaSampleController.cs (source to modify)
@Assets/AyaLiveStream/AyaChatUI.cs (has SetStatus(), LogSystemMessage(), HandleStateChanged())
@Packages/com.google.ai-embodiment/Runtime/PersonaSession.cs (OnSyncPacket, OnStateChanged events)
@Packages/com.google.ai-embodiment/Runtime/PacketAssembler.cs (SyncPacket structure)
@Packages/com.google.ai-embodiment/Runtime/SyncPacket.cs (packet type/fields)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add connection status and SyncPacket validation to AyaSampleController</name>
  <files>
    Assets/AyaLiveStream/AyaSampleController.cs
    Packages/com.google.ai-embodiment/Samples~/AyaLiveStream/AyaSampleController.cs
  </files>
  <action>
    Modify AyaSampleController.cs to add two new event subscriptions in Start():

    1. **Connection status feedback via OnStateChanged:**
       Subscribe `_session.OnStateChanged += HandleStateChanged;` in Start().
       Add handler:
       ```csharp
       private void HandleStateChanged(SessionState state)
       {
           _chatUI.SetStatus(state switch
           {
               SessionState.Connecting => "Connecting to Gemini...",
               SessionState.Connected => "Live! Hold SPACE to talk.",
               SessionState.Disconnecting => "Disconnecting...",
               SessionState.Disconnected => "Disconnected.",
               SessionState.Error => "Connection error.",
               _ => state.ToString()
           });
       }
       ```
       Unsubscribe in OnDestroy(): `_session.OnStateChanged -= HandleStateChanged;`

       Note: AyaChatUI already subscribes to OnStateChanged internally and handles it. However, AyaSampleController also calls `_chatUI.SetStatus()` during the intro phase ("Aya's intro playing...", "Going live..."). Adding HandleStateChanged to the controller ensures the status is kept up-to-date during the intro-to-connect transition. The controller's SetStatus calls during intro will be overwritten once Connect() fires state changes, which is correct behavior.

    2. **SyncPacket validation logging via OnSyncPacket:**
       Subscribe `_session.OnSyncPacket += HandleSyncPacket;` in Start().
       Add handler:
       ```csharp
       private void HandleSyncPacket(SyncPacket packet)
       {
           Debug.Log($"[SyncPacket] Turn={packet.TurnId} Seq={packet.Sequence} " +
                     $"Type={packet.Type} Text=\"{packet.Text}\" " +
                     $"Audio={packet.Audio?.Length ?? 0} samples " +
                     $"IsTurnEnd={packet.IsTurnEnd}");
       }
       ```
       Unsubscribe in OnDestroy(): `_session.OnSyncPacket -= HandleSyncPacket;`

    3. **Sync to Samples~:**
       After modifying `Assets/AyaLiveStream/AyaSampleController.cs`, copy the file to `Packages/com.google.ai-embodiment/Samples~/AyaLiveStream/AyaSampleController.cs` to keep the canonical sample source in sync.

    IMPORTANT: Add `using UnityEngine;` is already imported. Ensure `SyncPacket` and `SessionState` are accessible (they are in the `AIEmbodiment` namespace which is already imported).
  </action>
  <verify>
    Run: `grep "OnStateChanged +=" Assets/AyaLiveStream/AyaSampleController.cs` -- should find the subscription
    Run: `grep "OnSyncPacket +=" Assets/AyaLiveStream/AyaSampleController.cs` -- should find the subscription
    Run: `grep "HandleStateChanged" Assets/AyaLiveStream/AyaSampleController.cs` -- should find the handler method
    Run: `grep "HandleSyncPacket" Assets/AyaLiveStream/AyaSampleController.cs` -- should find the handler method
    Run: `diff Assets/AyaLiveStream/AyaSampleController.cs Packages/com.google.ai-embodiment/Samples~/AyaLiveStream/AyaSampleController.cs` -- should produce no output (files identical)
  </verify>
  <done>
    AyaSampleController subscribes to OnStateChanged and OnSyncPacket.
    HandleStateChanged routes connection status to AyaChatUI.SetStatus().
    HandleSyncPacket logs packet metadata via Debug.Log for validation.
    Both OnDestroy unsubscriptions are present.
    Samples~ copy is identical to Assets/ copy.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete v0.8 integration: scene YAML with correct AudioPlayback/AudioSource wiring, AIEmbodimentSettings asset in Resources, AyaSampleController with connection status feedback and SyncPacket validation logging, all .meta files present, Samples~ synchronized.
  </what-built>
  <how-to-verify>
    1. Open the Unity project in the Editor
    2. Navigate to Assets/Resources/AIEmbodimentSettings in the Inspector
    3. Enter your Google AI API key in the API Key field and save
    4. Open Assets/Scenes/AyaSampleScene
    5. Verify in Inspector:
       - AyaSession GameObject: AudioPlayback component has AudioSource assigned (not None)
       - AyaSession GameObject: AudioSource component has PlayOnAwake unchecked
       - AyaSampleController: _session, _chatUI, _introAudioSource all assigned (not None)
    6. Enter Play Mode
    7. Verify connection status shows "Connecting to Gemini..." then "Live! Hold SPACE to talk."
    8. Hold SPACE and speak -- verify AI responds with voice audio and transcription in chat
    9. Check Console for [SyncPacket] log entries -- verify they show Turn, Seq, Type, Text, Audio sample counts
    10. (Optional) Change PersonaConfig voiceBackend to ChirpTTS, re-enter Play Mode, verify Chirp TTS produces audio and SyncPackets show Audio=0 (expected -- Chirp audio bypasses PacketAssembler)
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. AyaSampleController.cs subscribes to OnStateChanged and OnSyncPacket in Start()
2. AyaSampleController.cs unsubscribes from both in OnDestroy()
3. HandleStateChanged routes all 5 SessionState values to _chatUI.SetStatus()
4. HandleSyncPacket logs packet metadata with Debug.Log
5. Samples~ AyaSampleController.cs is byte-identical to Assets/ copy
6. Human verification confirms end-to-end flow works in Unity Editor
</verification>

<success_criteria>
AyaSampleController shows connection status via the chat UI status bar.
SyncPacket validation logging produces [SyncPacket] entries in Console during conversation.
Samples~ canonical copy is synchronized.
Human verifies the sample scene connects, sends/receives audio, displays transcription, and shows SyncPacket logs.
</success_criteria>

<output>
After completion, create `.planning/phases/11-integration-verification/11-02-SUMMARY.md`
</output>
