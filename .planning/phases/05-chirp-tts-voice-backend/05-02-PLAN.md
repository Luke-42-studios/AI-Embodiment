---
phase: 05-chirp-tts-voice-backend
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - Packages/com.google.ai-embodiment/Runtime/PersonaConfig.cs
  - Packages/com.google.ai-embodiment/Editor/PersonaConfigEditor.cs
autonomous: true

must_haves:
  truths:
    - "Developer can select Chirp TTS backend and see language/voice dropdowns in Inspector"
    - "Selecting a language filters applicable voices (all 30 voices available per locale)"
    - "Selecting Custom voice reveals custom voice name and cloning key fields"
    - "Developer can choose sentence-by-sentence or full-response synthesis mode"
    - "Full Cloud TTS voice name is stored internally on PersonaConfig (not just friendly name)"
  artifacts:
    - path: "Packages/com.google.ai-embodiment/Runtime/PersonaConfig.cs"
      provides: "Extended persona config with Chirp-specific fields"
      contains: "chirpLanguageCode"
    - path: "Packages/com.google.ai-embodiment/Editor/PersonaConfigEditor.cs"
      provides: "Custom Inspector with conditional dropdowns"
      contains: "CustomEditor"
  key_links:
    - from: "PersonaConfigEditor.cs"
      to: "PersonaConfig.cs"
      via: "SerializedProperty access to Chirp fields"
      pattern: "serializedObject\\.FindProperty"
    - from: "PersonaConfigEditor.cs"
      to: "ChirpVoiceList.cs"
      via: "Voice and language data for dropdown population"
      pattern: "ChirpVoiceList\\."
---

<objective>
Extend PersonaConfig with Chirp TTS configuration fields and create a custom Inspector editor with language-filtered voice dropdown and custom voice support.

Purpose: Developers need to configure the Chirp TTS voice backend per-persona through the Inspector. This plan adds the serialized fields to PersonaConfig (language, synthesis mode, custom voice name, cloning key) and creates a PersonaConfigEditor that shows/hides fields contextually: Chirp-specific fields only appear when VoiceBackend is ChirpTTS, and custom voice fields only appear when "Custom" is selected in the voice dropdown.

Output: Extended PersonaConfig.cs with new fields, new PersonaConfigEditor.cs in the Editor folder
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-chirp-tts-voice-backend/05-CONTEXT.md

Source files:
@Packages/com.google.ai-embodiment/Runtime/PersonaConfig.cs
@Packages/com.google.ai-embodiment/Runtime/VoiceBackend.cs
@Packages/com.google.ai-embodiment/Editor/com.google.ai-embodiment.editor.asmdef

NOTE: This plan references ChirpVoiceList from Plan 01. If Plan 01 has not executed yet, the Editor script will reference ChirpVoiceList which may not exist on disk. This is fine -- both plans are Wave 1 and the code will compile once both complete. However, if you need to verify compilation, ensure Plan 01 files exist first.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend PersonaConfig with Chirp fields</name>
  <files>Packages/com.google.ai-embodiment/Runtime/PersonaConfig.cs</files>
  <action>
Add new serialized fields to PersonaConfig under the existing `[Header("Voice")]` section. Keep all existing fields intact. Add AFTER the existing `chirpVoiceName` field:

```csharp
[Header("Voice")]
public VoiceBackend voiceBackend = VoiceBackend.GeminiNative;
public string geminiVoiceName = "Puck";

// Chirp TTS configuration
public string chirpLanguageCode = "en-US";
public string chirpVoiceShortName = "Achernar";
public string chirpVoiceName = "en-US-Chirp3-HD-Achernar";  // Full API name (set by Editor)
public ChirpSynthesisMode chirpSynthesisMode = ChirpSynthesisMode.SentenceBySentence;
public string customVoiceName = "";
public string voiceCloningKey = "";
```

IMPORTANT: Rename the existing `chirpVoiceName` field to `chirpVoiceName` (it stays as the full API name). Add `chirpVoiceShortName` as a new field for the friendly display name. The Editor will set `chirpVoiceName` automatically from `chirpLanguageCode` + `chirpVoiceShortName` using `ChirpVoiceList.GetApiVoiceName()`.

Also add a `ChirpSynthesisMode` enum in the SAME file (below the class, still in the AIEmbodiment namespace):

```csharp
/// <summary>
/// Controls how Chirp TTS synthesizes audio from AI text output.
/// </summary>
public enum ChirpSynthesisMode
{
    /// <summary>Synthesize each sentence as PacketAssembler emits it. Lower latency to first audio.</summary>
    SentenceBySentence,

    /// <summary>Wait for complete AI response, synthesize once. Higher quality, higher latency.</summary>
    FullResponse
}
```

Add a convenience property to check if using custom voice:
```csharp
/// <summary>True when Chirp backend with a custom (cloned) voice is configured.</summary>
public bool IsCustomChirpVoice => voiceBackend == VoiceBackend.ChirpTTS
    && chirpVoiceShortName == ChirpVoiceList.CustomVoice;
```

Do NOT change any existing field names or defaults for fields not being modified. The `chirpVoiceName` field existed before with default `"en-US-Chirp3-HD-Achernar"` -- keep that default.
  </action>
  <verify>File compiles. PersonaConfig has fields: chirpLanguageCode, chirpVoiceShortName, chirpVoiceName, chirpSynthesisMode, customVoiceName, voiceCloningKey. ChirpSynthesisMode enum exists with SentenceBySentence and FullResponse values.</verify>
  <done>PersonaConfig.cs has all Chirp-specific fields for language, voice selection, synthesis mode, and custom voice cloning.</done>
</task>

<task type="auto">
  <name>Task 2: PersonaConfigEditor custom Inspector</name>
  <files>Packages/com.google.ai-embodiment/Editor/PersonaConfigEditor.cs</files>
  <action>
Create `PersonaConfigEditor.cs` in `Packages/com.google.ai-embodiment/Editor/`. This is a `[CustomEditor(typeof(PersonaConfig))]` class extending `UnityEditor.Editor` in the `AIEmbodiment.Editor` namespace.

**Structure:**

1. **OnEnable:** Cache all SerializedProperty references via `serializedObject.FindProperty("fieldName")` for every PersonaConfig field.

2. **OnInspectorGUI:** Draw all fields with conditional visibility:

   a. **Identity section** -- Draw displayName, archetype, backstory using `EditorGUILayout.PropertyField`. Group under label "Identity".

   b. **Personality section** -- Draw personalityTraits, speechPatterns.

   c. **Model section** -- Draw modelName, temperature.

   d. **Voice section** -- Draw voiceBackend as enum popup. Then:

      - If `voiceBackend == GeminiNative`: Show only `geminiVoiceName` as a text field.

      - If `voiceBackend == ChirpTTS`: Show:
        1. **Language dropdown:** Use `EditorGUILayout.Popup` with display names from `ChirpVoiceList.Languages`. Find current index by matching `chirpLanguageCode` value. On change, update `chirpLanguageCode` and rebuild `chirpVoiceName`.

        2. **Voice dropdown:** Use `EditorGUILayout.Popup` with names from `ChirpVoiceList.GetVoiceDisplayNames()` (30 voices + "Custom"). Find current index by matching `chirpVoiceShortName`. On change, update `chirpVoiceShortName` and rebuild `chirpVoiceName` via `ChirpVoiceList.GetApiVoiceName(languageCode, shortName)`.

        3. **If voice == "Custom":** Show two additional fields:
           - `customVoiceName` as EditorGUILayout.TextField("Custom Voice Name", ...)
           - `voiceCloningKey` as EditorGUILayout.TextField("Voice Cloning Key", ...)
           - Show info box: `EditorGUILayout.HelpBox("Custom voices use plain text (no SSML). Cloning key is obtained via the voices:generateVoiceCloningKey API.", MessageType.Info)`

        4. **Synthesis mode:** Draw `chirpSynthesisMode` as enum popup with tooltip explaining the tradeoff.
           - If SentenceBySentence: Show info: "Each sentence synthesized as it arrives. ~200-500ms latency per sentence."
           - If FullResponse: Show info: "Entire response synthesized at once. Higher latency but single request."

3. **Auto-sync chirpVoiceName:** Whenever language or voice short name changes, recompute `chirpVoiceName` from `ChirpVoiceList.GetApiVoiceName(chirpLanguageCode, chirpVoiceShortName)` and write it to the serialized property. This ensures the full API name is always in sync.

4. **Apply modified properties:** Call `serializedObject.ApplyModifiedProperties()` at the end of OnInspectorGUI.

**Key details:**
- Use `EditorGUI.indentLevel++` / `--` for nested fields under Voice section.
- Use `EditorGUILayout.Space()` between sections for visual clarity.
- All 30 voice names are available regardless of language selection (Chirp 3 HD voices work across all locales). The language dropdown controls the locale prefix, not which voices are shown.
- The dropdown indices should handle gracefully if the stored value doesn't match any entry (default to index 0).
  </action>
  <verify>File compiles (requires ChirpVoiceList.cs from Plan 01 to exist). Uses [CustomEditor(typeof(PersonaConfig))]. Shows/hides Chirp fields based on voiceBackend selection. Shows/hides custom voice fields based on voice dropdown selection. chirpVoiceName auto-syncs when language or voice changes.</verify>
  <done>PersonaConfigEditor.cs provides a polished Inspector experience: language dropdown, voice dropdown with "Custom" option, conditional field visibility, and auto-synced full API voice name.</done>
</task>

</tasks>

<verification>
- PersonaConfig.cs compiles with all new fields and the ChirpSynthesisMode enum
- PersonaConfigEditor.cs compiles (once ChirpVoiceList exists from Plan 01)
- Editor asmdef already references the Runtime asmdef (verified: com.google.ai-embodiment.editor.asmdef has "com.google.ai-embodiment" in references)
- Selecting GeminiNative in voiceBackend hides all Chirp fields
- Selecting ChirpTTS shows language, voice, and synthesis mode dropdowns
- Selecting Custom voice shows custom voice name and cloning key fields
- Changing language or voice updates chirpVoiceName automatically
</verification>

<success_criteria>
- PersonaConfig has chirpLanguageCode, chirpVoiceShortName, chirpVoiceName, chirpSynthesisMode, customVoiceName, voiceCloningKey fields
- ChirpSynthesisMode enum has SentenceBySentence and FullResponse values
- PersonaConfigEditor conditionally shows/hides fields based on voiceBackend and voice selection
- Custom voice fields (name + cloning key) appear only when "Custom" is selected
- Full API voice name auto-syncs in chirpVoiceName field
</success_criteria>

<output>
After completion, create `.planning/phases/05-chirp-tts-voice-backend/05-02-SUMMARY.md`
</output>
