---
phase: 16-integration-experience-loop
plan: 02
type: execute
wave: 2
depends_on: ["16-01"]
files_modified:
  - Assets/AyaLiveStream/NarrativeBeatConfig.cs
  - Assets/AyaLiveStream/ChatBotManager.cs
  - Assets/AyaLiveStream/NarrativeDirector.cs
autonomous: true

must_haves:
  truths:
    - "Chat bots can select catalyst messages that push the narrative toward the current beat's goal"
    - "Dynamic bot responses include Aya's recent transcript and established facts in the Gemini prompt"
    - "User PTT speech about a future beat topic advances the narrative to that specific beat (not just the final beat)"
    - "Beat transitions update the FactTracker with beat-level facts"
  artifacts:
    - path: "Assets/AyaLiveStream/NarrativeBeatConfig.cs"
      provides: "catalystGoal and catalystMessages fields on beat config"
      contains: "catalystGoal"
    - path: "Assets/AyaLiveStream/ChatBotManager.cs"
      provides: "Context-enriched dynamic prompts and catalyst message selection"
      contains: "SetContextProviders"
    - path: "Assets/AyaLiveStream/NarrativeDirector.cs"
      provides: "FactTracker integration and enhanced skip-ahead for future beats"
      contains: "SetFactTracker"
  key_links:
    - from: "Assets/AyaLiveStream/ChatBotManager.cs"
      to: "AyaTranscriptBuffer"
      via: "SetContextProviders stores reference, BuildDynamicPrompt uses GetRecentTurns"
      pattern: "_ayaTranscriptBuffer.*GetRecentTurns"
    - from: "Assets/AyaLiveStream/ChatBotManager.cs"
      to: "FactTracker"
      via: "SetContextProviders stores reference, BuildDynamicPrompt uses GetFactsSummary"
      pattern: "_factTracker.*GetFactsSummary"
    - from: "Assets/AyaLiveStream/NarrativeDirector.cs"
      to: "FactTracker"
      via: "SetFactTracker stores reference, ExecuteBeatTransition calls SetFact"
      pattern: "_factTracker.*SetFact"
---

<objective>
Wire cross-system context injection between subsystems and add narrative catalyst tuning. This is the coherence layer -- bots know what Aya said, Aya knows what bots said, and no system contradicts established facts.

Purpose: Implements requirements NAR-04 (bots as narrative catalysts) and NAR-05 (user questions accelerate narrative). After this plan, the experience has cross-system coherence -- the primary differentiator from disconnected subsystems.

Output: Modified NarrativeBeatConfig (catalyst fields), ChatBotManager (enriched prompts + catalyst selection), NarrativeDirector (fact tracking + enhanced skip-ahead).
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-integration-experience-loop/16-RESEARCH.md
@.planning/phases/16-integration-experience-loop/16-01-SUMMARY.md

@Assets/AyaLiveStream/NarrativeBeatConfig.cs
@Assets/AyaLiveStream/ChatBotManager.cs
@Assets/AyaLiveStream/NarrativeDirector.cs
@Assets/AyaLiveStream/FactTracker.cs
@Assets/AyaLiveStream/AyaTranscriptBuffer.cs
@Assets/AyaLiveStream/LivestreamController.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: NarrativeBeatConfig catalyst fields and ChatBotManager context injection + catalyst selection</name>
  <files>
    Assets/AyaLiveStream/NarrativeBeatConfig.cs
    Assets/AyaLiveStream/ChatBotManager.cs
  </files>
  <action>
    PART A: Extend NarrativeBeatConfig.cs (add fields to existing class, do NOT rewrite existing fields):

    Add a new [Header("Catalyst")] section after the existing [Header("Skip Detection")] section:
    - [TextArea(1, 3)] [Tooltip("What are bots trying to nudge Aya toward in this beat?")] public string catalystGoal;
    - [TextArea(1, 3)] [Tooltip("Catalyst messages sprinkled in chat to push narrative forward.")] public string[] catalystMessages;
    - [Tooltip("Keywords in user speech that indicate interest in this beat's topic. Used for PTT skip-ahead to specific beats.")] public string[] topicKeywords;

    topicKeywords is separate from skipKeywords. skipKeywords triggers skip to the FINAL beat. topicKeywords enables jumping to THIS specific beat when the user mentions these topics while on an earlier beat.

    PART B: Extend ChatBotManager.cs (modify existing class, preserve ALL existing functionality):

    Add private fields:
    - private AyaTranscriptBuffer _ayaTranscriptBuffer;
    - private FactTracker _factTracker;
    - private NarrativeBeatConfig _currentBeat; (updated by NarrativeDirector via a public method or event)

    Add public method:
    - SetContextProviders(AyaTranscriptBuffer transcriptBuffer, FactTracker factTracker) -- stores references. Called by LivestreamController in Start().
    - SetCurrentBeat(NarrativeBeatConfig beat) -- stores current beat reference for catalyst selection. Will be called from LivestreamController subscribing to NarrativeDirector.OnBeatStarted.

    Modify BuildDynamicPrompt(string userTranscript) to inject Aya context and facts:
    - After the existing "The viewer just said via push-to-talk:" section, add:
      1. If _ayaTranscriptBuffer is not null: get recent 3 turns via GetRecentTurns(3). If not empty, append "Aya (the host) has been saying:" + turns + blank line.
      2. If _factTracker is not null: get facts via GetFactsSummary(). If not empty, append "Established facts (do NOT contradict these):" + facts + blank line.
    - Keep all existing prompt content (bot list, rules) AFTER the new context sections.

    Modify PickMessage(ChatBotConfig bot) to support catalyst messages:
    - At the TOP of PickMessage, BEFORE the existing message pool logic:
      1. Check if _currentBeat != null AND _currentBeat.catalystMessages != null AND _currentBeat.catalystMessages.Length > 0
      2. If so, roll UnityEngine.Random.value. If < 0.25f (25% chance), pick a random catalyst message from _currentBeat.catalystMessages and return it directly (bypassing the per-bot pool).
      3. Otherwise, fall through to existing PickMessage logic unchanged.
    - This approach sprinkles catalyst messages organically across ALL bots (any bot can say a catalyst message). The 25% rate means roughly 1 in 4 burst messages nudges the narrative forward.
    - IMPORTANT: catalyst messages bypass per-bot tracking (_usedMessageIndices) because they come from the beat, not the bot's pool.
  </action>
  <verify>
    Open NarrativeBeatConfig.cs: confirm catalystGoal (string), catalystMessages (string[]), and topicKeywords (string[]) fields exist under a Catalyst header. Open ChatBotManager.cs: confirm SetContextProviders and SetCurrentBeat methods exist. Confirm BuildDynamicPrompt includes Aya transcript buffer and fact tracker context injection. Confirm PickMessage has the 25% catalyst message selection at the top before existing logic.
  </verify>
  <done>
    NarrativeBeatConfig has catalyst authoring fields (catalystGoal, catalystMessages, topicKeywords). ChatBotManager accepts cross-system context (AyaTranscriptBuffer, FactTracker), enriches dynamic Gemini prompts with Aya transcript + facts, and selects catalyst messages 25% of the time during scripted bursts.
  </done>
</task>

<task type="auto">
  <name>Task 2: NarrativeDirector FactTracker integration and enhanced skip-ahead</name>
  <files>
    Assets/AyaLiveStream/NarrativeDirector.cs
  </files>
  <action>
    Extend NarrativeDirector.cs (modify existing class, preserve ALL existing functionality):

    Add private field:
    - private FactTracker _factTracker;

    Add public method:
    - SetFactTracker(FactTracker factTracker) -- stores reference. Called by LivestreamController in Start().

    Modify ExecuteBeatTransition(NarrativeBeatConfig beat):
    - AFTER the existing OnBeatStarted?.Invoke(beat) line, add:
      1. If _factTracker != null, set a fact for this beat: _factTracker.SetFact($"beat_{beat.beatId}_started")
      2. For the final beat specifically (_currentBeatIndex == _beats.Length - 1), also set: _factTracker.SetFact("approaching_reveal")

    Modify the beat loop (OnBeatEnded section in RunBeatLoop):
    - AFTER OnBeatEnded?.Invoke(beat), add:
      1. If _factTracker != null: _factTracker.SetFact($"beat_{beat.beatId}_completed")

    Enhance CheckSkipKeywords(string transcript) to support future-beat topic matching:
    - KEEP the existing skipKeywords logic that skips to the final beat.
    - BEFORE the existing skipKeywords check, add a NEW section that checks topicKeywords on all FUTURE beats (not current, not past):
      1. Iterate from _currentBeatIndex + 1 to _beats.Length - 1 (exclusive of current and final beat -- final beat skip is handled by existing skipKeywords)
      2. For each future beat, check its topicKeywords array
      3. If transcript contains any of that beat's topicKeywords (case-insensitive IndexOf, same pattern as existing skipKeywords check), then:
         - Set _currentBeatIndex to that beat's index - 1 (so the loop advances to it on next iteration)
         - Set _beatGoalMet = true (triggers early exit from current beat)
         - Debug.Log($"[NarrativeDirector] Topic keyword match for beat '{futureBeat.beatId}', advancing.")
         - return (don't check further beats or skipKeywords)
      4. If no topicKeyword match, fall through to existing skipKeywords logic.
    - This way: topicKeywords on beat 2 let the user jump from beat 1 directly to beat 2 by mentioning beat 2's topics. skipKeywords remain the "fast forward to finale" mechanism.

    IMPORTANT: The topicKeywords check must NOT trigger if _currentBeatIndex is already at or past the target beat index. Only check FUTURE beats (index > _currentBeatIndex).
  </action>
  <verify>
    Open NarrativeDirector.cs: confirm SetFactTracker method exists. Confirm ExecuteBeatTransition calls _factTracker.SetFact for beat start. Confirm RunBeatLoop calls _factTracker.SetFact for beat completion. Confirm CheckSkipKeywords has a NEW topicKeywords section that iterates future beats BEFORE the existing skipKeywords section. Verify the topicKeywords check only looks at beats with index > _currentBeatIndex and < _beats.Length - 1.
  </verify>
  <done>
    NarrativeDirector tracks beat-level facts in FactTracker (beat started/completed, approaching_reveal). User speech with topic keywords matching a future beat advances the narrative to that specific beat. Existing skipKeywords fast-forward-to-finale behavior preserved.
  </done>
</task>

</tasks>

<verification>
- NarrativeBeatConfig has catalystGoal, catalystMessages, topicKeywords fields
- ChatBotManager.SetContextProviders accepts AyaTranscriptBuffer + FactTracker
- ChatBotManager.SetCurrentBeat accepts NarrativeBeatConfig for catalyst selection
- ChatBotManager.BuildDynamicPrompt includes Aya transcript and fact context
- ChatBotManager.PickMessage selects catalyst messages ~25% of the time when a beat has them
- NarrativeDirector.SetFactTracker accepts FactTracker
- NarrativeDirector updates FactTracker at beat start and beat end
- NarrativeDirector.CheckSkipKeywords checks topicKeywords on future beats for beat-specific skip-ahead
- All existing functionality preserved (burst loop, dynamic responses, beat progression, scene execution)
</verification>

<success_criteria>
Cross-system context injection is wired: bots know what Aya said (via AyaTranscriptBuffer in prompt), bots respect established facts (via FactTracker in prompt), bots nudge narrative forward (via catalyst messages), and users can accelerate to specific beats (via topicKeywords). The coherence layer is complete and ready for Plan 03's integration validation.
</success_criteria>

<output>
After completion, create `.planning/phases/16-integration-experience-loop/16-02-SUMMARY.md`
</output>
