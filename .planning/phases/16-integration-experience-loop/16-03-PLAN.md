---
phase: 16-integration-experience-loop
plan: 03
type: execute
wave: 3
depends_on: ["16-02"]
files_modified:
  - Assets/AyaLiveStream/LivestreamController.cs
  - Assets/AyaLiveStream/Editor/CreateBeatAssets.cs
autonomous: false

must_haves:
  truths:
    - "LivestreamController wires context providers to subsystems and subscribes to OnBeatStarted for catalyst beat tracking"
    - "Beat assets include catalyst messages and topic keywords authored for each beat"
    - "The full experience loop is validated: Aya greets, bots chat with catalysts, narrative builds, user PTT works, movie clip loads"
  artifacts:
    - path: "Assets/AyaLiveStream/LivestreamController.cs"
      provides: "Final wiring connecting FactTracker/AyaTranscriptBuffer to ChatBotManager and NarrativeDirector"
      contains: "SetContextProviders"
    - path: "Assets/AyaLiveStream/Editor/CreateBeatAssets.cs"
      provides: "Updated beat assets with catalystGoal, catalystMessages, and topicKeywords"
      contains: "catalystGoal"
  key_links:
    - from: "Assets/AyaLiveStream/LivestreamController.cs"
      to: "ChatBotManager.SetContextProviders"
      via: "Start() method call"
      pattern: "_chatBotManager\\.SetContextProviders"
    - from: "Assets/AyaLiveStream/LivestreamController.cs"
      to: "NarrativeDirector.SetFactTracker"
      via: "Start() method call"
      pattern: "_narrativeDirector\\.SetFactTracker"
    - from: "Assets/AyaLiveStream/LivestreamController.cs"
      to: "ChatBotManager.SetCurrentBeat"
      via: "OnBeatStarted subscription"
      pattern: "_chatBotManager\\.SetCurrentBeat"
---

<objective>
Complete the integration wiring in LivestreamController (connecting Plan 01's context objects to Plan 02's subsystem APIs), update beat asset content with catalyst messages and topic keywords, and validate the full experience loop.

Purpose: This plan closes the circuit. Plan 01 created the context providers and orchestrator skeleton. Plan 02 added the injection points on subsystems. Plan 03 wires them together, authors the narrative content, and validates end-to-end.

Output: Fully wired LivestreamController, beat assets with catalyst content, validated experience loop.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-integration-experience-loop/16-RESEARCH.md
@.planning/phases/16-integration-experience-loop/16-01-SUMMARY.md
@.planning/phases/16-integration-experience-loop/16-02-SUMMARY.md

@Assets/AyaLiveStream/LivestreamController.cs
@Assets/AyaLiveStream/Editor/CreateBeatAssets.cs
@Assets/AyaLiveStream/NarrativeBeatConfig.cs
@Assets/AyaLiveStream/ChatBotManager.cs
@Assets/AyaLiveStream/NarrativeDirector.cs
@Assets/AyaLiveStream/FactTracker.cs
@Assets/AyaLiveStream/AyaTranscriptBuffer.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Complete LivestreamController wiring and update CreateBeatAssets with catalyst content</name>
  <files>
    Assets/AyaLiveStream/LivestreamController.cs
    Assets/AyaLiveStream/Editor/CreateBeatAssets.cs
  </files>
  <action>
    PART A: Complete wiring in LivestreamController.Start() (add to existing Start method from Plan 01):

    After creating _ayaTranscriptBuffer and _factTracker, BEFORE subscribing to PersonaSession events, add:
    1. _chatBotManager.SetContextProviders(_ayaTranscriptBuffer, _factTracker) -- connects cross-system context to bot prompt enrichment
    2. _narrativeDirector.SetFactTracker(_factTracker) -- connects fact tracking to beat lifecycle
    3. Subscribe to _narrativeDirector.OnBeatStarted: handler calls _chatBotManager.SetCurrentBeat(beat) so ChatBotManager knows which beat is active for catalyst selection

    Also ensure OnDestroy unsubscribes from _narrativeDirector.OnBeatStarted.

    PART B: Update CreateBeatAssets.cs to include catalyst content for each beat:

    Beat 1 (BEAT_WARMUP):
    - catalystGoal = "Get Aya talking about what she's working on today"
    - catalystMessages = new string[] {
        "ooh what are you drawing today??",
        "is this a new project or something you've been working on?",
        "I love watching you start new pieces! what's the plan today?"
      }
    - topicKeywords = new string[0] (first beat -- no one skips TO the first beat)

    Beat 2 (BEAT_ART):
    - catalystGoal = "Get Aya to talk about the characters she's designing and tease the reveal"
    - catalystMessages = new string[] {
        "are those character designs?? they look amazing",
        "tell us about the characters!! who are they?",
        "I can see you're working on something special... what is it?",
        "omg those characters look so cool, what's their story?"
      }
    - topicKeywords = new string[] { "character", "design", "drawing", "sketch", "art style" }

    Beat 3 (BEAT_CHARACTERS):
    - catalystGoal = "Push Aya toward revealing the movie clip"
    - catalystMessages = new string[] {
        "omg are you gonna show us the thing??",
        "I heard you've been working on something big... is it ready??",
        "SHOW US SHOW US",
        "wait is there a video?? please tell me there's a video",
        "I've been waiting for this reveal all stream!!"
      }
    - topicKeywords = new string[] { "movie", "film", "clip", "video", "animation", "reveal", "show" }
    - NOTE: Beat 3 already has skipKeywords = new string[0]. The topicKeywords here enable jumping FROM earlier beats TO this beat. Since this is the final beat, topicKeywords overlap with beat 2's skipKeywords but the mechanism is different (topicKeywords = jump to specific beat, skipKeywords = jump to final beat from current).

    IMPORTANT: Preserve ALL existing beat content (beatId, title, timeBudgetSeconds, urgency, goalDescription, directorNote, scenes, slowChatDuringAya, skipKeywords). Only ADD the three new fields (catalystGoal, catalystMessages, topicKeywords) to each beat.
  </action>
  <verify>
    Open LivestreamController.cs: confirm Start() calls _chatBotManager.SetContextProviders and _narrativeDirector.SetFactTracker. Confirm OnBeatStarted subscription calls _chatBotManager.SetCurrentBeat. Open CreateBeatAssets.cs: confirm all 3 beats have catalystGoal, catalystMessages, and topicKeywords assigned. Confirm existing beat content is unchanged.
  </verify>
  <done>
    LivestreamController fully wires FactTracker and AyaTranscriptBuffer to ChatBotManager and NarrativeDirector. Beat assets include narrative catalyst content and topic keywords. The integration circuit is closed -- context flows bidirectionally between all subsystems.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete Phase 16 integration: LivestreamController orchestrator with loading/going-live transition, FactTracker for cross-system coherence, AyaTranscriptBuffer for Aya-to-bot context, catalyst messages on beat configs, enriched dynamic bot prompts, enhanced PTT skip-ahead to specific beats, dead air detection, orderly shutdown before scene transition, and thinking indicator UI.

    All subsystems are wired:
    - LivestreamController -> PersonaSession (connect, events, function registration)
    - LivestreamController -> NarrativeDirector (StartNarrative, FactTracker, OnAllBeatsComplete shutdown)
    - LivestreamController -> ChatBotManager (StartBursts/StopBursts, context providers, current beat)
    - LivestreamController -> LivestreamUI (loading state, going live, thinking indicator, transcript, toast)
    - NarrativeDirector -> FactTracker (beat start/end facts)
    - ChatBotManager -> AyaTranscriptBuffer + FactTracker (enriched dynamic prompts)
    - ChatBotManager -> NarrativeBeatConfig.catalystMessages (25% catalyst selection in bursts)
    - NarrativeDirector.CheckSkipKeywords -> topicKeywords (future-beat jump)
  </what-built>
  <how-to-verify>
    Code review validation (since Unity Play Mode requires scene setup):

    1. Open Assets/AyaLiveStream/LivestreamController.cs in the editor
       - Verify [SerializeField] fields for all 6 subsystems + AnimationConfig + configuration floats
       - Verify Start() creates FactTracker + AyaTranscriptBuffer, wires to subsystems, subscribes to events
       - Verify InitializeAndStart() shows loading -> polls for connection -> shows "going live" -> starts subsystems
       - Verify HandleNarrativeComplete stops ChatBotManager before scene transition
       - Verify OnDestroy unsubscribes all events

    2. Open Assets/AyaLiveStream/FactTracker.cs and AyaTranscriptBuffer.cs
       - Verify clean plain C# classes with correct APIs

    3. Open Assets/AyaLiveStream/ChatBotManager.cs
       - Verify SetContextProviders and SetCurrentBeat methods
       - Verify BuildDynamicPrompt includes Aya transcript and facts
       - Verify PickMessage has 25% catalyst selection at top

    4. Open Assets/AyaLiveStream/NarrativeDirector.cs
       - Verify SetFactTracker method
       - Verify ExecuteBeatTransition sets facts
       - Verify CheckSkipKeywords checks topicKeywords on future beats

    5. Open Assets/AyaLiveStream/NarrativeBeatConfig.cs
       - Verify catalystGoal, catalystMessages, topicKeywords fields

    6. Open Assets/AyaLiveStream/LivestreamUI.cs
       - Verify SetLoadingState, ShowGoingLive, ShowThinkingIndicator methods

    7. Run "AI Embodiment > Samples > Create Demo Beat Assets" in Unity Editor
       - Verify beat assets regenerate with catalyst content
       - Inspect each .asset in Inspector to confirm catalyst fields populated

    Type "approved" to complete Phase 16, or describe any issues found.
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
- LivestreamController.Start() calls SetContextProviders and SetFactTracker
- LivestreamController subscribes to OnBeatStarted -> SetCurrentBeat
- CreateBeatAssets generates all 3 beats with catalystGoal, catalystMessages, topicKeywords
- Full experience flow: loading -> connecting -> going live -> Aya greets -> bots chat (with catalysts) -> beat progression -> user PTT (enriched bot responses, skip-ahead) -> all beats complete -> ChatBotManager stopped -> scene transition to movie clip
- Requirements coverage: LIVE-01 (full scene), NAR-04 (catalyst messages), NAR-05 (PTT skip-ahead)
</verification>

<success_criteria>
The complete livestream experience loop is wired end-to-end. A developer can open the LivestreamSample scene, assign LivestreamController's SerializeField references in the Inspector, enter Play Mode, and experience: loading state -> "GOING LIVE!" -> Aya greeting -> bot chat with narrative catalysts -> beat progression -> optional PTT with enriched bot responses and skip-ahead -> movie clip reveal. Requirements LIVE-01, NAR-04, NAR-05 are satisfied.
</success_criteria>

<output>
After completion, create `.planning/phases/16-integration-experience-loop/16-03-SUMMARY.md`
</output>
