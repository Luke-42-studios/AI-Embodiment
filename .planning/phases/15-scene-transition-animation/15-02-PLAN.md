---
phase: 15-scene-transition-animation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - Assets/AyaLiveStream/SceneTransitionHandler.cs
autonomous: true

must_haves:
  truths:
    - "When the narrative reaches all-beats-complete, the livestream scene fully unloads and the movie clip scene loads"
    - "PersonaSession.Disconnect() is called explicitly before scene load (no reliance on destruction order)"
    - "If the movie scene is not in Build Settings, a clear error message appears in console"
    - "Scene transition is instant cut (no fade, no crossfade) -- livestream disappears, movie scene appears"
    - "Transition only fires once (guard against duplicate OnAllBeatsComplete calls)"
  artifacts:
    - path: "Assets/AyaLiveStream/SceneTransitionHandler.cs"
      provides: "MonoBehaviour that listens to NarrativeDirector.OnAllBeatsComplete and loads movie scene"
      exports: ["SceneTransitionHandler"]
      min_lines: 40
  key_links:
    - from: "SceneTransitionHandler.cs"
      to: "NarrativeDirector.OnAllBeatsComplete"
      via: "event subscription in OnEnable"
      pattern: "OnAllBeatsComplete.*\\+="
    - from: "SceneTransitionHandler.cs"
      to: "PersonaSession.Disconnect"
      via: "explicit disconnect before scene load"
      pattern: "_session.*Disconnect"
    - from: "SceneTransitionHandler.cs"
      to: "SceneManager.LoadSceneAsync"
      via: "LoadSceneMode.Single for clean exit"
      pattern: "LoadSceneAsync.*Single"
---

<objective>
Create SceneTransitionHandler MonoBehaviour that listens to NarrativeDirector.OnAllBeatsComplete and performs a clean scene exit: disconnects the PersonaSession WebSocket, then loads the movie clip scene via SceneManager.LoadSceneAsync with LoadSceneMode.Single (destroying the current livestream scene entirely).

Purpose: Provides the narrative climax transition from livestream to movie clip reveal. Clean exit means no additive loading complexity, no dual-AudioListener management. The handler is the bridge between narrative completion and scene loading. This fulfills ANI-02 (simplified) and ANI-03 (removed -- no pre-loading needed).

Output: SceneTransitionHandler.cs MonoBehaviour ready to be wired in the Unity Inspector.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-scene-transition-animation/15-CONTEXT.md
@.planning/phases/15-scene-transition-animation/15-RESEARCH.md
@Assets/AyaLiveStream/NarrativeDirector.cs
@Packages/com.google.ai-embodiment/Runtime/PersonaSession.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SceneTransitionHandler with clean scene exit</name>
  <files>Assets/AyaLiveStream/SceneTransitionHandler.cs</files>
  <action>
Create SceneTransitionHandler.cs in the AIEmbodiment.Samples namespace as a MonoBehaviour:

```csharp
using UnityEngine;
using UnityEngine.SceneManagement;

namespace AIEmbodiment.Samples
{
    /// <summary>
    /// Handles the clean scene transition from the livestream to the movie clip
    /// when the NarrativeDirector signals all beats are complete.
    ///
    /// Transition is a clean exit: PersonaSession disconnects (WebSocket closes,
    /// audio stops, TTS disposes), then SceneManager loads the movie scene with
    /// LoadSceneMode.Single (destroying the current scene entirely).
    ///
    /// Wire in Inspector: assign NarrativeDirector, PersonaSession, and the movie
    /// scene name. The movie scene MUST be added to File > Build Settings > Scenes In Build.
    /// </summary>
    public class SceneTransitionHandler : MonoBehaviour
    {
        [SerializeField] private NarrativeDirector _narrativeDirector;
        [SerializeField] private PersonaSession _session;

        [Header("Movie Scene")]
        [Tooltip("Name of the movie scene to load. Must be in Build Settings.")]
        [SerializeField] private string _movieSceneName = "MovieScene";

        private bool _transitioning;

        private void OnEnable()
        {
            if (_narrativeDirector != null)
                _narrativeDirector.OnAllBeatsComplete += HandleAllBeatsComplete;
        }

        private void OnDisable()
        {
            if (_narrativeDirector != null)
                _narrativeDirector.OnAllBeatsComplete -= HandleAllBeatsComplete;
        }

        private void HandleAllBeatsComplete()
        {
            if (_transitioning) return;
            _transitioning = true;

            Debug.Log($"[SceneTransition] Narrative complete. Transitioning to '{_movieSceneName}'.");

            // Clean disconnect first -- WebSocket closes, audio stops, TTS disposes
            // (Pitfall 4: explicit Disconnect before scene load avoids destruction-order races)
            if (_session != null)
                _session.Disconnect();

            // Verify scene is in Build Settings before attempting load
            if (Application.CanStreamedLevelBeLoaded(_movieSceneName))
            {
                SceneManager.LoadSceneAsync(_movieSceneName, LoadSceneMode.Single);
            }
            else
            {
                Debug.LogError(
                    $"[SceneTransition] Scene '{_movieSceneName}' not found in Build Settings. " +
                    "Add it via File > Build Settings > Scenes In Build.");
                _transitioning = false; // Reset so it can be retried after fixing
            }
        }
    }
}
```

Key design decisions reflected in this code:
- **Clean exit (not additive):** LoadSceneMode.Single destroys the current scene. Per CONTEXT.md: "Clean exit: livestream scene fully unloads, movie clip scene loads independently, WebSocket disconnects -- session is over."
- **Explicit Disconnect before load:** Per Pitfall 4 from research -- do not rely on OnDestroy firing in the right order. Call Disconnect() explicitly before LoadSceneAsync.
- **Build Settings validation:** Per Pitfall 3 from research -- check Application.CanStreamedLevelBeLoaded before attempting load. Clear error message tells developer exactly what to do.
- **Transition guard:** _transitioning flag prevents duplicate calls if OnAllBeatsComplete fires more than once.
- **No pre-loading:** Per CONTEXT.md user decision -- a brief loading moment is acceptable, no allowSceneActivation complexity.
- **Instant cut:** Per CONTEXT.md -- no fade to black, no crossfade. Scene loads and appears immediately.
- **No toast before transition:** The previous iteration of research showed a toast "The story continues..." but this conflicts with instant cut -- the toast would flash for a frame then disappear. Skip it.

IMPORTANT: The NarrativeDirector reference may be null if Phase 14 has not been wired yet in the Unity scene. The OnEnable/OnDisable null checks handle this gracefully. The handler can exist in the scene and be wired when NarrativeDirector is ready (Phase 16 integration).
  </action>
  <verify>
SceneTransitionHandler.cs compiles. Verify: has [SerializeField] for NarrativeDirector, PersonaSession, and _movieSceneName. OnEnable subscribes to OnAllBeatsComplete. OnDisable unsubscribes. HandleAllBeatsComplete calls Disconnect() then LoadSceneAsync with LoadSceneMode.Single. Has _transitioning guard. Has Application.CanStreamedLevelBeLoaded check with Debug.LogError fallback.
  </verify>
  <done>SceneTransitionHandler listens for narrative completion, disconnects the session cleanly, validates the target scene exists in Build Settings, and loads it with a clean single-mode async load. Transition fires exactly once. Developer gets a clear error if the movie scene is missing from Build Settings.</done>
</task>

</tasks>

<verification>
1. SceneTransitionHandler.cs compiles in AIEmbodiment.Samples namespace
2. Subscribes to NarrativeDirector.OnAllBeatsComplete in OnEnable, unsubscribes in OnDisable
3. Calls PersonaSession.Disconnect() BEFORE SceneManager.LoadSceneAsync (Pitfall 4)
4. Uses LoadSceneMode.Single (clean exit, not additive)
5. Checks Application.CanStreamedLevelBeLoaded before attempting load (Pitfall 3)
6. Has _transitioning guard against duplicate calls
7. Debug.Log documents transition start; Debug.LogError documents missing scene
8. No pre-loading, no fade, no additive loading (matches CONTEXT.md simplifications)
9. NarrativeDirector null-check in OnEnable/OnDisable for safe standalone existence
</verification>

<success_criteria>
- SceneTransitionHandler exists and compiles with Inspector-configurable fields
- When NarrativeDirector.OnAllBeatsComplete fires, session disconnects and movie scene loads
- If movie scene is not in Build Settings, clear error message appears in console
- Transition fires exactly once regardless of how many times OnAllBeatsComplete is invoked
- Code follows async LoadSceneAsync pattern (no frame freeze from sync load)
</success_criteria>

<output>
After completion, create `.planning/phases/15-scene-transition-animation/15-02-SUMMARY.md`
</output>
