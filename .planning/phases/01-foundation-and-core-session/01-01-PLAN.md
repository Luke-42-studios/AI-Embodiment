---
phase: 01-foundation-and-core-session
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Assets/Firebase/FirebaseAI/Firebase.AI.asmdef
  - Packages/com.google.ai-embodiment/package.json
  - Packages/com.google.ai-embodiment/Runtime/com.google.ai-embodiment.asmdef
  - Packages/com.google.ai-embodiment/Runtime/MainThreadDispatcher.cs
  - Packages/com.google.ai-embodiment/Runtime/SessionState.cs
  - Packages/com.google.ai-embodiment/Editor/com.google.ai-embodiment.editor.asmdef
  - Packages/com.google.ai-embodiment/Tests/Runtime/com.google.ai-embodiment.tests.asmdef
  - Packages/com.google.ai-embodiment/CHANGELOG.md
  - Packages/com.google.ai-embodiment/LICENSE.md
autonomous: true

must_haves:
  truths:
    - "UPM package is recognized by Unity (appears in Package Manager window)"
    - "Firebase AI SDK compiles as a separate assembly (Firebase.AI.asmdef exists and project compiles)"
    - "Runtime assembly references Firebase.AI assembly without errors"
    - "MainThreadDispatcher auto-initializes before any scene loads and survives scene transitions"
    - "Actions enqueued from background threads execute on the main thread in Update"
  artifacts:
    - path: "Assets/Firebase/FirebaseAI/Firebase.AI.asmdef"
      provides: "Firebase AI SDK as a separate assembly for cross-assembly referencing"
      contains: "Firebase.AI"
    - path: "Packages/com.google.ai-embodiment/package.json"
      provides: "UPM package manifest"
      contains: "com.google.ai-embodiment"
    - path: "Packages/com.google.ai-embodiment/Runtime/com.google.ai-embodiment.asmdef"
      provides: "Runtime assembly definition referencing Firebase.AI"
      contains: "Firebase.AI"
    - path: "Packages/com.google.ai-embodiment/Runtime/MainThreadDispatcher.cs"
      provides: "Thread-safe main thread dispatch via ConcurrentQueue"
      min_lines: 30
    - path: "Packages/com.google.ai-embodiment/Runtime/SessionState.cs"
      provides: "Session lifecycle state enum"
      contains: "enum SessionState"
  key_links:
    - from: "Packages/com.google.ai-embodiment/Runtime/com.google.ai-embodiment.asmdef"
      to: "Assets/Firebase/FirebaseAI/Firebase.AI.asmdef"
      via: "assembly reference in references array"
      pattern: "Firebase\\.AI"
    - from: "Packages/com.google.ai-embodiment/Runtime/MainThreadDispatcher.cs"
      to: "UnityEngine.MonoBehaviour"
      via: "Update loop draining ConcurrentQueue"
      pattern: "ConcurrentQueue.*Action"
---

<objective>
Create the UPM package skeleton and foundational infrastructure: Firebase AI assembly definition, package structure, MainThreadDispatcher, and SessionState enum.

Purpose: Nothing else in Phase 1 compiles until the Firebase AI SDK has its own asmdef and the UPM package structure exists with a Runtime asmdef that references it. MainThreadDispatcher is the critical threading primitive that PersonaSession (Plan 01-03) depends on for safe background-to-main-thread marshaling.

Output: A compiling UPM package with Firebase.AI cross-assembly reference and a working MainThreadDispatcher singleton.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-and-core-session/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Firebase AI asmdef and UPM package skeleton</name>
  <files>
    Assets/Firebase/FirebaseAI/Firebase.AI.asmdef
    Packages/com.google.ai-embodiment/package.json
    Packages/com.google.ai-embodiment/Runtime/com.google.ai-embodiment.asmdef
    Packages/com.google.ai-embodiment/Editor/com.google.ai-embodiment.editor.asmdef
    Packages/com.google.ai-embodiment/Tests/Runtime/com.google.ai-embodiment.tests.asmdef
    Packages/com.google.ai-embodiment/CHANGELOG.md
    Packages/com.google.ai-embodiment/LICENSE.md
  </files>
  <action>
    **Step 1: Create Firebase.AI assembly definition.**

    Create `Assets/Firebase/FirebaseAI/Firebase.AI.asmdef` with these exact settings:
    ```json
    {
        "name": "Firebase.AI",
        "rootNamespace": "Firebase.AI",
        "references": [],
        "includePlatforms": [],
        "excludePlatforms": [],
        "allowUnsafeCode": false,
        "overrideReferences": true,
        "precompiledReferences": [
            "Google.MiniJson.dll",
            "Firebase.App.dll",
            "Firebase.Platform.dll",
            "Firebase.TaskExtension.dll"
        ],
        "autoReferenced": true,
        "defineConstraints": [],
        "versionDefines": [],
        "noEngineReferences": false
    }
    ```
    Critical: `overrideReferences` MUST be `true` with `precompiledReferences` listing the exact DLL filenames from `Assets/Firebase/Plugins/`. The Firebase AI source files reference types from these DLLs (FirebaseApp from Firebase.App.dll, Json from Google.MiniJson.dll, Firebase.Platform and Firebase.TaskExtension for async helpers). The Internal/ and Imagen/ subfolders are automatically included in the parent asmdef -- do NOT create separate asmdefs for them.

    **Step 2: Create UPM package directory structure.**

    Create the following directory tree under `Packages/com.google.ai-embodiment/`:
    ```
    Packages/com.google.ai-embodiment/
      package.json
      CHANGELOG.md
      LICENSE.md
      Runtime/
        com.google.ai-embodiment.asmdef
      Editor/
        com.google.ai-embodiment.editor.asmdef
      Tests/
        Runtime/
          com.google.ai-embodiment.tests.asmdef
      Samples~/
      Documentation~/
    ```

    Note: The package lives under `Packages/` (not project root) so Unity auto-discovers it as an embedded UPM package. `Samples~/` and `Documentation~/` are empty directories (the `~` suffix tells Unity to ignore them for compilation).

    **Step 3: Create package.json.**

    ```json
    {
      "name": "com.google.ai-embodiment",
      "version": "0.1.0",
      "displayName": "AI Embodiment",
      "description": "Drop-in AI conversational characters for Unity with synchronized voice, text, and animation events.",
      "unity": "6000.0",
      "dependencies": {},
      "author": {
        "name": "Google"
      },
      "keywords": ["ai", "gemini", "conversational", "npc", "character"]
    }
    ```

    **Step 4: Create Runtime asmdef.**

    `Packages/com.google.ai-embodiment/Runtime/com.google.ai-embodiment.asmdef`:
    ```json
    {
        "name": "com.google.ai-embodiment",
        "rootNamespace": "AIEmbodiment",
        "references": [
            "Firebase.AI"
        ],
        "includePlatforms": [],
        "excludePlatforms": [],
        "allowUnsafeCode": false,
        "overrideReferences": false,
        "precompiledReferences": [],
        "autoReferenced": true,
        "defineConstraints": [],
        "versionDefines": [],
        "noEngineReferences": false
    }
    ```
    The `references` array contains `"Firebase.AI"` which is the asmdef name created in Step 1.

    **Step 5: Create Editor asmdef.**

    `Packages/com.google.ai-embodiment/Editor/com.google.ai-embodiment.editor.asmdef`:
    ```json
    {
        "name": "com.google.ai-embodiment.editor",
        "rootNamespace": "AIEmbodiment.Editor",
        "references": [
            "com.google.ai-embodiment"
        ],
        "includePlatforms": ["Editor"],
        "excludePlatforms": [],
        "allowUnsafeCode": false,
        "overrideReferences": false,
        "precompiledReferences": [],
        "autoReferenced": true,
        "defineConstraints": [],
        "versionDefines": [],
        "noEngineReferences": false
    }
    ```

    **Step 6: Create Tests/Runtime asmdef.**

    `Packages/com.google.ai-embodiment/Tests/Runtime/com.google.ai-embodiment.tests.asmdef`:
    ```json
    {
        "name": "com.google.ai-embodiment.tests",
        "rootNamespace": "AIEmbodiment.Tests",
        "references": [
            "com.google.ai-embodiment",
            "UnityEngine.TestRunner",
            "UnityEditor.TestRunner"
        ],
        "includePlatforms": [],
        "excludePlatforms": [],
        "allowUnsafeCode": false,
        "overrideReferences": false,
        "precompiledReferences": [],
        "autoReferenced": false,
        "defineConstraints": [
            "UNITY_INCLUDE_TESTS"
        ],
        "versionDefines": [],
        "noEngineReferences": false
    }
    ```

    **Step 7: Create CHANGELOG.md and LICENSE.md.**

    CHANGELOG.md: Standard keepachangelog format with `## [0.1.0] - Unreleased` section noting "Initial package structure."

    LICENSE.md: MIT license with "Google" and current year.
  </action>
  <verify>
    1. Verify all files exist: `ls -R Packages/com.google.ai-embodiment/` and `ls Assets/Firebase/FirebaseAI/Firebase.AI.asmdef`
    2. Validate JSON syntax: `python3 -c "import json; json.load(open('Packages/com.google.ai-embodiment/package.json'))"` (repeat for each .asmdef)
    3. Verify the Runtime asmdef references Firebase.AI: grep for "Firebase.AI" in the Runtime asmdef
  </verify>
  <done>
    - Firebase.AI.asmdef exists at Assets/Firebase/FirebaseAI/ with overrideReferences: true and all 4 precompiledReferences
    - UPM package directory tree exists under Packages/com.google.ai-embodiment/
    - Runtime asmdef references Firebase.AI
    - All JSON files are valid
  </done>
</task>

<task type="auto">
  <name>Task 2: MainThreadDispatcher and SessionState enum</name>
  <files>
    Packages/com.google.ai-embodiment/Runtime/MainThreadDispatcher.cs
    Packages/com.google.ai-embodiment/Runtime/SessionState.cs
  </files>
  <action>
    **MainThreadDispatcher.cs** -- Create in `Packages/com.google.ai-embodiment/Runtime/`:

    Namespace: `AIEmbodiment`

    A MonoBehaviour singleton that:
    1. Auto-initializes via `[RuntimeInitializeOnLoadMethod(RuntimeInitializeLoadType.BeforeSceneLoad)]` -- creates a hidden GameObject named `[MainThreadDispatcher]`
    2. Calls `DontDestroyOnLoad(gameObject)` so it survives scene transitions
    3. Has a `private static readonly ConcurrentQueue<Action> _queue` field
    4. Has a `public static void Enqueue(Action action)` method that throws `ArgumentNullException` if action is null, then enqueues to the ConcurrentQueue
    5. In `Update()`, drains the queue with `while (_queue.TryDequeue(out var action))`, wrapping each `action.Invoke()` in a try-catch that calls `Debug.LogException(ex)` -- one bad callback must NOT kill the drain loop
    6. In `OnDestroy()`, nulls the static `_instance` reference only if `_instance == this`
    7. The Initialize method checks `_instance == null` before creating (prevents duplicates)
    8. Hides the GameObject in the hierarchy: `go.hideFlags = HideFlags.HideAndDontSave;` -- this is a library internal, not something developers should see or select

    Required usings: `System`, `System.Collections.Concurrent`, `UnityEngine`

    Follow the exact pattern from the research document (Pattern 1) but add `hideFlags = HideFlags.HideAndDontSave` to the GameObject.

    **SessionState.cs** -- Create in `Packages/com.google.ai-embodiment/Runtime/`:

    Namespace: `AIEmbodiment`

    A public enum with values: `Disconnected`, `Connecting`, `Connected`, `Disconnecting`, `Error`

    This matches the state machine from the research document (Pattern 6). Note the inclusion of `Disconnecting` -- this represents the state during async cleanup in Disconnect() before reaching Disconnected.
  </action>
  <verify>
    1. Verify files exist: `ls Packages/com.google.ai-embodiment/Runtime/MainThreadDispatcher.cs Packages/com.google.ai-embodiment/Runtime/SessionState.cs`
    2. Verify namespace: grep for `namespace AIEmbodiment` in both files
    3. Verify ConcurrentQueue usage: grep for `ConcurrentQueue` in MainThreadDispatcher.cs
    4. Verify RuntimeInitializeOnLoadMethod: grep for `RuntimeInitializeOnLoadMethod` in MainThreadDispatcher.cs
    5. Verify SessionState values: grep for `Disconnected.*Connecting.*Connected` in SessionState.cs
  </verify>
  <done>
    - MainThreadDispatcher.cs exists with ConcurrentQueue-based dispatch, auto-initialization, DontDestroyOnLoad, try-catch per action, and HideAndDontSave
    - SessionState.cs exists with all 5 states (Disconnected, Connecting, Connected, Disconnecting, Error)
    - Both files use namespace AIEmbodiment
    - No Firebase dependencies in either file (pure Unity/System)
  </done>
</task>

</tasks>

<verification>
1. All files exist in expected locations
2. All JSON files (package.json, all .asmdef files) parse without errors
3. Firebase.AI.asmdef has overrideReferences: true with correct precompiledReferences
4. Runtime asmdef references Firebase.AI
5. MainThreadDispatcher uses ConcurrentQueue, RuntimeInitializeOnLoadMethod, DontDestroyOnLoad, try-catch per action
6. SessionState enum has all 5 values
7. Both C# files use namespace AIEmbodiment
</verification>

<success_criteria>
- UPM package structure exists under Packages/com.google.ai-embodiment/ with all required directories and files
- Firebase.AI.asmdef enables cross-assembly referencing from the UPM package to the Firebase AI SDK
- MainThreadDispatcher provides thread-safe dispatch from background threads to Unity's main thread
- SessionState enum defines the session lifecycle states
- Requirements covered: PKG-01 (UPM package structure), SESS-07 (MainThreadDispatcher foundation), SESS-08 (SessionState enum)
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-and-core-session/01-01-SUMMARY.md`
</output>
