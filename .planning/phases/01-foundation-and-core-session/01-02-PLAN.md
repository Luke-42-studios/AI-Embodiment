---
phase: 01-foundation-and-core-session
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - Packages/com.luke42studios.ai-embodiment/Runtime/PersonaConfig.cs
  - Packages/com.luke42studios.ai-embodiment/Runtime/VoiceBackend.cs
  - Packages/com.luke42studios.ai-embodiment/Runtime/SystemInstructionBuilder.cs
autonomous: true

must_haves:
  truths:
    - "Developer can right-click in Project window and create AI Embodiment > Persona Config asset"
    - "PersonaConfig Inspector shows personality fields (archetype, traits, backstory, speech patterns), model selection, and voice settings"
    - "SystemInstructionBuilder produces a ModelContent containing formatted personality text from PersonaConfig fields"
    - "Voice backend enum allows selection between GeminiNative and ChirpTTS"
  artifacts:
    - path: "Packages/com.luke42studios.ai-embodiment/Runtime/PersonaConfig.cs"
      provides: "ScriptableObject with persona personality, model, and voice configuration"
      contains: "CreateAssetMenu"
      min_lines: 25
    - path: "Packages/com.luke42studios.ai-embodiment/Runtime/VoiceBackend.cs"
      provides: "Enum for voice backend selection"
      contains: "enum VoiceBackend"
    - path: "Packages/com.luke42studios.ai-embodiment/Runtime/SystemInstructionBuilder.cs"
      provides: "Static builder composing PersonaConfig into ModelContent system instruction"
      contains: "ModelContent"
      min_lines: 20
  key_links:
    - from: "Packages/com.luke42studios.ai-embodiment/Runtime/SystemInstructionBuilder.cs"
      to: "Packages/com.luke42studios.ai-embodiment/Runtime/PersonaConfig.cs"
      via: "Build(PersonaConfig) method parameter"
      pattern: "Build.*PersonaConfig"
    - from: "Packages/com.luke42studios.ai-embodiment/Runtime/SystemInstructionBuilder.cs"
      to: "Firebase.AI.ModelContent"
      via: "returns ModelContent.Text()"
      pattern: "ModelContent\\.Text"
    - from: "Packages/com.luke42studios.ai-embodiment/Runtime/PersonaConfig.cs"
      to: "Packages/com.luke42studios.ai-embodiment/Runtime/VoiceBackend.cs"
      via: "voiceBackend field type"
      pattern: "VoiceBackend"
---

<objective>
Create the PersonaConfig ScriptableObject, VoiceBackend enum, and SystemInstructionBuilder that converts persona configuration into a Gemini system instruction.

Purpose: PersonaConfig is the developer-facing entry point -- it is the first thing a developer interacts with when setting up an AI character. SystemInstructionBuilder converts that configuration into the Firebase AI SDK's ModelContent format, which PersonaSession (Plan 01-03) will pass to GetLiveModel() at connect time.

Output: Three C# files that give developers a complete persona configuration workflow through Unity's Inspector.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-and-core-session/01-RESEARCH.md
@.planning/phases/01-foundation-and-core-session/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: PersonaConfig ScriptableObject and VoiceBackend enum</name>
  <files>
    Packages/com.luke42studios.ai-embodiment/Runtime/PersonaConfig.cs
    Packages/com.luke42studios.ai-embodiment/Runtime/VoiceBackend.cs
  </files>
  <action>
    **VoiceBackend.cs** -- Create in `Packages/com.luke42studios.ai-embodiment/Runtime/`:

    Namespace: `AIEmbodiment`

    A public enum with two values:
    - `GeminiNative` -- Uses Gemini Live API's built-in voice synthesis
    - `ChirpTTS` -- Routes text to Cloud TTS Chirp 3 HD (implemented in Phase 5)

    Keep this in a separate file because other classes (PersonaSession, future ChirpTTSClient) will reference it independently of PersonaConfig.

    **PersonaConfig.cs** -- Create in `Packages/com.luke42studios.ai-embodiment/Runtime/`:

    Namespace: `AIEmbodiment`

    A ScriptableObject with `[CreateAssetMenu(fileName = "NewPersonaConfig", menuName = "AI Embodiment/Persona Config")]`.

    Fields organized with [Header] attributes:

    **Identity section:**
    - `public string displayName = "New Persona";` -- Character's display name
    - `public string archetype = "companion";` -- Character archetype (e.g., "companion", "merchant", "guide")
    - `[TextArea(3, 10)] public string backstory;` -- Character backstory and context

    **Personality section:**
    - `public string[] personalityTraits;` -- Array of personality trait strings (e.g., "friendly", "sarcastic")
    - `[TextArea(2, 5)] public string speechPatterns;` -- How the character talks (e.g., "speaks in short sentences", "uses medieval language")

    **Model section:**
    - `public string modelName = "gemini-2.5-flash-native-audio-preview-12-2025";` -- Default model per research findings. Configurable so developers can update without code changes (important: Gemini 2.0 Flash retires March 31, 2026)
    - `[Range(0f, 2f)] public float temperature = 0.7f;` -- Generation temperature

    **Voice section:**
    - `public VoiceBackend voiceBackend = VoiceBackend.GeminiNative;` -- Which voice synthesis path to use
    - `public string geminiVoiceName = "Puck";` -- Voice name for Gemini native path (30 voices available per research: Puck, Kore, Aoede, Charon, Fenrir, Zephyr, etc.)
    - `public string chirpVoiceName = "en-US-Chirp3-HD-Achernar";` -- Voice name for Chirp TTS path (Phase 5)

    No Firebase SDK types in this file. PersonaConfig is a pure Unity ScriptableObject -- the Firebase boundary is in SystemInstructionBuilder and PersonaSession only.
  </action>
  <verify>
    1. Verify files exist: `ls Packages/com.luke42studios.ai-embodiment/Runtime/PersonaConfig.cs Packages/com.luke42studios.ai-embodiment/Runtime/VoiceBackend.cs`
    2. Verify CreateAssetMenu: grep for `CreateAssetMenu` in PersonaConfig.cs
    3. Verify all field sections: grep for `Header.*Identity`, `Header.*Personality`, `Header.*Model`, `Header.*Voice` in PersonaConfig.cs
    4. Verify default model name: grep for `gemini-2.5-flash-native-audio` in PersonaConfig.cs
    5. Verify VoiceBackend enum values: grep for `GeminiNative` and `ChirpTTS` in VoiceBackend.cs
    6. Verify no Firebase imports: confirm PersonaConfig.cs does NOT contain `using Firebase`
  </verify>
  <done>
    - PersonaConfig.cs is a ScriptableObject with CreateAssetMenu, all 4 field sections (Identity, Personality, Model, Voice), and correct defaults (model = gemini-2.5-flash-native-audio-preview-12-2025, voice = Puck, temperature = 0.7)
    - VoiceBackend.cs has GeminiNative and ChirpTTS values
    - Neither file imports Firebase types
    - Requirements covered: SESS-01 (personality fields), SESS-02 (model selection), SESS-03 (voice backend and voice name)
  </done>
</task>

<task type="auto">
  <name>Task 2: SystemInstructionBuilder</name>
  <files>
    Packages/com.luke42studios.ai-embodiment/Runtime/SystemInstructionBuilder.cs
  </files>
  <action>
    **SystemInstructionBuilder.cs** -- Create in `Packages/com.luke42studios.ai-embodiment/Runtime/`:

    Namespace: `AIEmbodiment`

    A public static class with one public method:

    `public static ModelContent Build(PersonaConfig config)`

    This method composes the PersonaConfig fields into a formatted system instruction string, then wraps it in `ModelContent.Text()` (from Firebase.AI namespace).

    Implementation:
    1. Use `System.Text.StringBuilder` to build the instruction text
    2. Start with identity: `"You are {displayName}, a {archetype}."`
    3. If `backstory` is not null/empty, append a `BACKSTORY:` section with the backstory text
    4. If `personalityTraits` is not null and has elements, append a `PERSONALITY TRAITS:` section with each non-empty trait as a bullet point (`- {trait}`)
    5. If `speechPatterns` is not null/empty, append a `SPEECH PATTERNS:` section with the speech patterns text
    6. Return `ModelContent.Text(sb.ToString())`

    Guard against null config: if config is null, throw `ArgumentNullException`.

    Each section separated by a blank line for readability.

    Required usings: `System`, `System.Text`, `Firebase.AI` (for ModelContent)

    Follow the exact pattern from the research document (Pattern 5: SystemInstructionBuilder). This is the ONLY file in this plan that touches Firebase types -- it is the boundary between the package's configuration types and the Firebase SDK.
  </action>
  <verify>
    1. Verify file exists: `ls Packages/com.luke42studios.ai-embodiment/Runtime/SystemInstructionBuilder.cs`
    2. Verify Firebase import: grep for `using Firebase.AI` in SystemInstructionBuilder.cs
    3. Verify Build method signature: grep for `ModelContent Build.*PersonaConfig` in SystemInstructionBuilder.cs
    4. Verify ModelContent.Text usage: grep for `ModelContent.Text` in SystemInstructionBuilder.cs
    5. Verify all sections are built: grep for `BACKSTORY`, `PERSONALITY TRAITS`, `SPEECH PATTERNS` in SystemInstructionBuilder.cs
    6. Verify null guard: grep for `ArgumentNullException` in SystemInstructionBuilder.cs
  </verify>
  <done>
    - SystemInstructionBuilder.cs exists with a static Build(PersonaConfig) method returning ModelContent
    - Composes displayName, archetype, backstory, personalityTraits, and speechPatterns into formatted text
    - Uses ModelContent.Text() from Firebase.AI as the return type
    - Handles null/empty fields gracefully (skips empty sections)
    - Throws ArgumentNullException for null config
    - This is the single Firebase-touching boundary in the config layer
  </done>
</task>

</tasks>

<verification>
1. PersonaConfig is creatable via Assets > Create > AI Embodiment > Persona Config (CreateAssetMenu attribute present)
2. All personality fields are exposed in Inspector with appropriate editors (TextArea for long text, string[] for traits)
3. Model name defaults to gemini-2.5-flash-native-audio-preview-12-2025
4. VoiceBackend enum has exactly GeminiNative and ChirpTTS
5. SystemInstructionBuilder.Build() produces ModelContent containing all non-empty PersonaConfig sections
6. No Firebase types leak into PersonaConfig -- Firebase boundary is only in SystemInstructionBuilder
</verification>

<success_criteria>
- Developer can create a PersonaConfig ScriptableObject from the Unity Create menu
- PersonaConfig exposes personality fields, model selection, and voice backend choice in the Inspector
- SystemInstructionBuilder converts PersonaConfig into a Firebase ModelContent system instruction
- Requirements fully covered: SESS-01, SESS-02, SESS-03
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-and-core-session/01-02-SUMMARY.md`
</output>
