---
phase: 11.2-chirp-custom-voice-bearer-auth
verified: 2026-02-17T18:30:00Z
status: passed
score: 5/5 must-haves verified
---

# Phase 11.2: Chirp Custom Voice Bearer Auth Verification Report

**Phase Goal:** ChirpTTSClient authenticates with Google Cloud TTS via OAuth2 bearer tokens (service account JWT exchange) instead of API key, enabling Chirp Custom Voice cloning on the v1beta1 endpoint
**Verified:** 2026-02-17T18:30:00Z
**Status:** passed
**Re-verification:** No -- initial verification

## Goal Achievement

### Observable Truths

| # | Truth | Status | Evidence |
|---|-------|--------|----------|
| 1 | ChirpTTSClient generates a JWT from a service account JSON key, exchanges it for an OAuth2 access token via oauth2.googleapis.com/token, and uses Authorization: Bearer header for TTS requests | VERIFIED | GoogleServiceAccountAuth.cs (215 lines): RSA.Create + ImportPkcs8PrivateKey (line 81-82), BuildSignedJwt with RS256 signing (line 122-147), ExchangeJwtForToken form-encoded POST to oauth2.googleapis.com/token (line 165-198). ChirpTTSClient.cs uses `await _auth.GetAccessTokenAsync()` (line 121) and sets `Authorization: Bearer` header (line 122). |
| 2 | Access tokens are cached and automatically refreshed before the 1-hour expiry | VERIFIED | GoogleServiceAccountAuth.cs: `_cachedToken` and `_tokenExpiry` fields (line 35-36), `TOKEN_REFRESH_MARGIN_SECONDS = 300` (line 29), cache check in GetAccessTokenAsync returns early if token valid and not within 5-min margin (lines 106-110), `_tokenExpiry = DateTime.UtcNow.AddSeconds(expiresIn)` set after exchange (line 196). |
| 3 | Custom voice synthesis requests target texttospeech.googleapis.com/v1beta1/text:synthesize with voiceClone.voiceCloningKey in the request body | VERIFIED | ChirpTTSClient.cs: `TTS_ENDPOINT_V1BETA1 = "https://texttospeech.googleapis.com/v1beta1/text:synthesize"` (line 36), endpoint selected via `_auth != null ? TTS_ENDPOINT_V1BETA1 : TTS_ENDPOINT_V1` (line 112). BuildRequestJson (line 167-213) constructs `voiceClone.voiceCloningKey` in the voice object when `voiceCloningKey` is non-empty (lines 192-194). |
| 4 | Standard (non-custom) Chirp voices continue to work via the same bearer token auth path | VERIFIED | ChirpTTSClient.cs: Bearer auth constructor accepts optional `voiceCloningKey = null` (line 73). When null, `isCustomVoice` is false (line 173) and BuildRequestJson uses SSML input + named voice (lines 183, 198-199). Endpoint is still v1beta1 when `_auth != null` regardless of custom voice. API key fallback path preserved: `x-goog-api-key` header set when `_auth == null` (line 127). |
| 5 | Service account credentials are loaded securely (not shipped in player builds) | VERIFIED | AIEmbodimentSettings.cs: `_serviceAccountJsonPath` stores a file path (line 16), `LoadServiceAccountJson()` reads from filesystem at runtime via `File.ReadAllText` (line 43) -- never serialized into the asset. .gitignore has three patterns excluding service account JSON files (lines 36-38). Editor shows masked path by default (AIEmbodimentSettingsEditor.cs lines 70-77). |

**Score:** 5/5 truths verified

### Required Artifacts

| Artifact | Expected | Status | Details |
|----------|----------|--------|---------|
| `Packages/com.google.ai-embodiment/Runtime/GoogleServiceAccountAuth.cs` | OAuth2 credential provider with JWT signing and token caching | VERIFIED (215 lines, no stubs, imported by PersonaSession and ChirpTTSClient) | Complete implementation: constructor with JSON parsing + RSA key import, GetAccessTokenAsync with caching, BuildSignedJwt with RS256, ExchangeJwtForToken with form POST, IDisposable, ProjectId property |
| `Packages/com.google.ai-embodiment/Runtime/GoogleServiceAccountAuth.cs.meta` | Unity meta file | VERIFIED (2-line format, GUID present) | `fileFormatVersion: 2`, `guid: a7c3d1e4f58b42a69e0f3b7c8d2a1e5f` |
| `Packages/com.google.ai-embodiment/Runtime/ChirpTTSClient.cs` | Dual-auth TTS client with v1/v1beta1 endpoint switching | VERIFIED (271 lines, no stubs, wired via PersonaSession) | Two endpoint constants, two constructor overloads (API key vs bearer), endpoint/auth selection in SynthesizeAsync, x-goog-user-project header, auth-aware error messages |
| `Packages/com.google.ai-embodiment/Runtime/PersonaSession.cs` | Auth-aware TTS provider instantiation with lifecycle management | VERIFIED (912 lines, no stubs, central session manager) | `_serviceAuth` field, `new GoogleServiceAccountAuth(serviceAccountJson)` in Connect(), dual ChirpTTSClient instantiation, `_serviceAuth.Dispose()` in both Disconnect() and OnDestroy(), warning log for voiceCloningKey without service account |
| `Packages/com.google.ai-embodiment/Runtime/AIEmbodimentSettings.cs` | Service account JSON path field and LoadServiceAccountJson method | VERIFIED (64 lines, has exports, loaded by PersonaSession) | `_serviceAccountJsonPath` serialized field, `ServiceAccountJsonPath` property, `LoadServiceAccountJson()` with File.Exists guard and error logging |
| `Packages/com.google.ai-embodiment/Editor/AIEmbodimentSettingsEditor.cs` | Editor UI for service account file path | VERIFIED (123 lines, CustomEditor attribute wired) | Masked path display with Show/Hide toggle, Browse button with OpenFilePanel, three-state contextual HelpBox (empty, file-not-found, configured) |
| `.gitignore` | Service account JSON exclusion patterns | VERIFIED | Three patterns: `*.service-account.json`, `*-service-account.json`, `service-account*.json` |

### Key Link Verification

| From | To | Via | Status | Details |
|------|----|-----|--------|---------|
| GoogleServiceAccountAuth | oauth2.googleapis.com/token | UnityWebRequest.Post with WWWForm | WIRED | Form-encoded POST at line 171-172, grant_type and assertion fields at lines 168-169 |
| GoogleServiceAccountAuth | RSA.SignData | JWT RS256 signing | WIRED | `_rsa.SignData(input, HashAlgorithmName.SHA256, RSASignaturePadding.Pkcs1)` at lines 141-144 |
| PersonaSession.Connect | GoogleServiceAccountAuth constructor | LoadServiceAccountJson feeds JSON | WIRED | `settings.LoadServiceAccountJson()` at line 207, `new GoogleServiceAccountAuth(serviceAccountJson)` at line 213 |
| ChirpTTSClient.SynthesizeAsync | GoogleServiceAccountAuth.GetAccessTokenAsync | await before HTTP request | WIRED | `await _auth.GetAccessTokenAsync()` at line 121, before `await request.SendWebRequest()` at line 130 |
| ChirpTTSClient.SynthesizeAsync | v1beta1 endpoint | Endpoint selection via _auth != null | WIRED | `_auth != null ? TTS_ENDPOINT_V1BETA1 : TTS_ENDPOINT_V1` at line 112 |
| PersonaSession.Disconnect | GoogleServiceAccountAuth.Dispose | Dispose auth after TTS provider | WIRED | `_serviceAuth.Dispose()` at line 849 (Disconnect) and line 895 (OnDestroy) |
| ChirpTTSClient ownership | PersonaSession | Caller-owns pattern | WIRED | ChirpTTSClient.Dispose() does NOT call `_auth?.Dispose()` (confirmed absent). PersonaSession owns `_serviceAuth` lifetime. |

### Requirements Coverage

No requirements mapped to Phase 11.2 in REQUIREMENTS.md. Phase was inserted post-initial planning.

### Anti-Patterns Found

| File | Line | Pattern | Severity | Impact |
|------|------|---------|----------|--------|
| (none) | - | - | - | No TODO, FIXME, placeholder, or stub patterns found in any modified file |

### Human Verification Required

### 1. Service Account Bearer Auth End-to-End

**Test:** Configure a Google Cloud service account JSON in AIEmbodimentSettings, connect a session with ChirpTTS voice backend, verify audio synthesis works via the v1beta1 endpoint with bearer auth.
**Expected:** Audio plays back using Chirp voice, no 401/403 errors in console. Debug log should NOT show API key auth path.
**Why human:** Requires valid Google Cloud service account credentials and network connectivity to test actual OAuth2 token exchange.

### 2. Custom Voice Cloning

**Test:** Set a `voiceCloningKey` on PersonaConfig with a valid service account, connect, and trigger TTS synthesis.
**Expected:** Audio plays back using the cloned voice. The request body should include `voiceClone.voiceCloningKey` (verifiable via network inspector or debug logging).
**Why human:** Requires a valid voice cloning key from Google Cloud TTS custom voice feature.

### 3. API Key Fallback

**Test:** Remove the service account path from AIEmbodimentSettings (leave it empty), keep API key set, connect with ChirpTTS backend.
**Expected:** Audio synthesizes via v1 endpoint with API key auth, identical to pre-phase-11.2 behavior. No errors or warnings about service account.
**Why human:** Requires running the Unity application with a valid API key.

### 4. Editor UI

**Test:** Open AIEmbodimentSettings in the Unity Inspector. Verify the Service Account section appears with Browse button, masked path, Show/Hide toggle, and correct HelpBox messages for each state (empty, file-not-found, configured).
**Expected:** UI matches the described behavior. Browse opens a file picker filtered to .json files.
**Why human:** Visual UI verification requires running the Unity Editor.

### Gaps Summary

No gaps found. All five success criteria from the ROADMAP are fully verified at the code level:

1. JWT generation, OAuth2 token exchange, and Bearer header usage are all implemented with correct cryptographic operations and HTTP semantics.
2. Token caching with 5-minute refresh margin before 1-hour expiry is implemented.
3. v1beta1 endpoint targeting with voiceClone.voiceCloningKey in request body is implemented.
4. Standard voices work via both bearer auth (v1beta1) and API key (v1) paths.
5. Service account credentials are loaded from filesystem path at runtime, never serialized into assets, and protected by .gitignore patterns.

---

_Verified: 2026-02-17T18:30:00Z_
_Verifier: Claude (gsd-verifier)_
