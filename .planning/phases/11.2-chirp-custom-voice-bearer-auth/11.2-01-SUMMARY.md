---
phase: 11.2-chirp-custom-voice-bearer-auth
plan: 01
subsystem: auth
tags: [oauth2, jwt, rsa, service-account, google-cloud, tts, bearer-token]

# Dependency graph
requires:
  - phase: 09
    provides: ChirpTTSClient and ITTSProvider interface
  - phase: 08-01
    provides: AIEmbodimentSettings ScriptableObject with editor UI
provides:
  - GoogleServiceAccountAuth credential provider (JWT signing + token exchange + caching)
  - AIEmbodimentSettings.LoadServiceAccountJson() for service account file loading
  - Editor UI with file picker for service account configuration
affects: [11.2-02, chirp-custom-voice]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Standalone credential provider pattern (auth separate from HTTP client)"
    - "JWT RS256 signing with System.Security.Cryptography (no external auth library)"
    - "Form-encoded POST for OAuth2 token exchange"
    - "Token caching with 5-minute refresh margin"

key-files:
  created:
    - Packages/com.google.ai-embodiment/Runtime/GoogleServiceAccountAuth.cs
    - Packages/com.google.ai-embodiment/Runtime/GoogleServiceAccountAuth.cs.meta
  modified:
    - Packages/com.google.ai-embodiment/Runtime/AIEmbodimentSettings.cs
    - Packages/com.google.ai-embodiment/Editor/AIEmbodimentSettingsEditor.cs
    - .gitignore

key-decisions:
  - "Manual JWT signing (~200 lines) instead of Google.Apis.Auth NuGet dependency"
  - "Service account JSON loaded from file path at runtime, never serialized into Unity asset"
  - "Base64url encoding via Convert.ToBase64String + char replacement (JWT spec)"
  - "Token refresh margin of 300 seconds (5 min) before 1-hour expiry"

patterns-established:
  - "GoogleServiceAccountAuth: IDisposable credential provider with async token access"
  - "Service account path masked in editor UI by default (screen-sharing safety)"

# Metrics
duration: 2min
completed: 2026-02-17
---

# Phase 11.2 Plan 01: OAuth2 Service Account Auth Infrastructure Summary

**GoogleServiceAccountAuth credential provider with JWT RS256 signing, OAuth2 token exchange, 5-min-margin caching, and editor UI file picker for service account configuration**

## Performance

- **Duration:** 2 min
- **Started:** 2026-02-17T18:06:48Z
- **Completed:** 2026-02-17T18:08:53Z
- **Tasks:** 3
- **Files modified:** 5

## Accomplishments
- Created GoogleServiceAccountAuth class: loads service account JSON, signs RS256 JWT, exchanges for OAuth2 access token via form-encoded POST, caches token with 5-minute refresh margin
- Extended AIEmbodimentSettings with service account JSON file path field and LoadServiceAccountJson() method
- Added editor UI with masked path display, Show/Hide toggle, Browse file picker, and contextual HelpBox messages
- Protected service account files from accidental git commits via .gitignore patterns

## Task Commits

Each task was committed atomically:

1. **Task 1: Create GoogleServiceAccountAuth credential provider** - `04ccd0c` (feat)
2. **Task 2: Add service account path to settings and editor UI** - `ab174aa` (feat)
3. **Task 3: Update .gitignore for service account JSON files** - `fca8002` (chore)

## Files Created/Modified
- `Packages/com.google.ai-embodiment/Runtime/GoogleServiceAccountAuth.cs` - OAuth2 credential provider with JWT signing, token exchange, caching
- `Packages/com.google.ai-embodiment/Runtime/GoogleServiceAccountAuth.cs.meta` - Unity meta file (2-line format)
- `Packages/com.google.ai-embodiment/Runtime/AIEmbodimentSettings.cs` - Added _serviceAccountJsonPath field and LoadServiceAccountJson()
- `Packages/com.google.ai-embodiment/Editor/AIEmbodimentSettingsEditor.cs` - Added service account section with masked path, Browse button, contextual help
- `.gitignore` - Added service account JSON exclusion patterns

## Decisions Made
- Manual JWT signing using System.Security.Cryptography (RSA.Create + ImportPkcs8PrivateKey + SignData) instead of pulling in Google.Apis.Auth NuGet -- avoids heavy dependency tree and Unity NuGet fragility
- Service account JSON loaded from file path at runtime (never serialized into ScriptableObject asset) -- private keys must not end up in builds
- Base64url encoding via Convert.ToBase64String with TrimEnd('=').Replace('+','-').Replace('/','_') -- standard JWT spec pattern
- Token refresh margin of 300 seconds before 3600-second expiry -- prevents mid-flight token expiration
- Service account path masked by default in editor (dots display) matching existing API key pattern -- screen-sharing safety

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered
None

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness
- GoogleServiceAccountAuth is ready to be consumed by ChirpTTSClient in Plan 02
- AIEmbodimentSettings.LoadServiceAccountJson() provides the JSON string GoogleServiceAccountAuth constructor needs
- Plan 02 will wire auth into ChirpTTSClient (dual-auth: API key v1 / bearer token v1beta1) and PersonaSession lifecycle

---
*Phase: 11.2-chirp-custom-voice-bearer-auth*
*Completed: 2026-02-17*
