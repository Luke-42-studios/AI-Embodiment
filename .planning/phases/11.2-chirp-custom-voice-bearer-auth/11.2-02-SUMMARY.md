---
phase: 11.2-chirp-custom-voice-bearer-auth
plan: 02
subsystem: auth
tags: [oauth2, bearer-token, chirp, tts, v1beta1, service-account, unity]

# Dependency graph
requires:
  - phase: 11.2-01
    provides: GoogleServiceAccountAuth credential provider, AIEmbodimentSettings service account path
provides:
  - Dual-auth ChirpTTSClient (API key v1 / bearer token v1beta1)
  - PersonaSession service account lifecycle management
  - Auth-aware TTS provider instantiation
affects: [11.1-queued-response-sample]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Dual-auth constructor overload pattern (API key vs bearer token)"
    - "Caller-owns-lifetime pattern (PersonaSession owns GoogleServiceAccountAuth, not ChirpTTSClient)"

key-files:
  created: []
  modified:
    - "Packages/com.google.ai-embodiment/Runtime/ChirpTTSClient.cs"
    - "Packages/com.google.ai-embodiment/Runtime/PersonaSession.cs"

key-decisions:
  - "PersonaSession owns GoogleServiceAccountAuth lifetime, not ChirpTTSClient (caller-owns pattern)"
  - "ChirpTTSClient does NOT dispose _auth in its Dispose() -- avoids double-dispose"
  - "API key check in Connect() stays as-is: Gemini Live WebSocket always needs API key regardless of TTS auth path"

patterns-established:
  - "Dual-auth constructor overload: one for API key, one for bearer auth"
  - "Warning log when voice cloning key set without service account"

# Metrics
duration: 2min
completed: 2026-02-17
---

# Phase 11.2 Plan 02: ChirpTTSClient Dual-Auth Wiring Summary

**Dual-auth ChirpTTSClient with v1/v1beta1 endpoint switching and PersonaSession service account lifecycle management**

## Performance

- **Duration:** 2 min
- **Started:** 2026-02-17T18:10:46Z
- **Completed:** 2026-02-17T18:12:54Z
- **Tasks:** 2
- **Files modified:** 2

## Accomplishments
- ChirpTTSClient supports both API key auth (v1 endpoint) and bearer token auth (v1beta1 endpoint)
- PersonaSession creates GoogleServiceAccountAuth from AIEmbodimentSettings when service account is configured
- API key fallback preserved for backward compatibility when no service account present
- Service account auth properly disposed in both Disconnect() and OnDestroy()
- Warning log when voice cloning key is set without service account configured

## Task Commits

Each task was committed atomically:

1. **Task 1: Add bearer token auth and v1beta1 endpoint to ChirpTTSClient** - `3dca754` (feat)
2. **Task 2: Wire service account auth into PersonaSession TTS provider creation** - `d1e0cc8` (feat)

## Files Created/Modified
- `Packages/com.google.ai-embodiment/Runtime/ChirpTTSClient.cs` - Dual endpoint constants, GoogleServiceAccountAuth field, bearer auth constructor overload, endpoint/auth selection in SynthesizeAsync, auth-aware error messages
- `Packages/com.google.ai-embodiment/Runtime/PersonaSession.cs` - _serviceAuth field, LoadServiceAccountJson call in Connect(), bearer-vs-API-key ChirpTTSClient instantiation, _serviceAuth disposal in Disconnect() and OnDestroy()

## Decisions Made
- PersonaSession owns GoogleServiceAccountAuth lifetime (caller-owns pattern) -- ChirpTTSClient does NOT dispose _auth. This avoids double-dispose and is consistent with PersonaSession already owning _ttsProvider lifecycle.
- API key check in Connect() stays as-is: the Gemini Live WebSocket connection always needs an API key. Bearer auth is only for TTS requests, not the Gemini session itself.

## Deviations from Plan

None - plan executed exactly as written. The plan itself noted the ownership correction (Task 1 should NOT add _auth?.Dispose() to ChirpTTSClient.Dispose()) and this was followed.

## Issues Encountered
None

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness
- Phase 11.2 is complete: full OAuth2 bearer token auth pipeline from service account JSON to v1beta1 TTS requests
- Custom voice cloning is ready for end-to-end testing (requires a valid service account JSON and voice cloning key)
- Phase 11.1 (Queued Response Sample) can proceed independently

---
*Phase: 11.2-chirp-custom-voice-bearer-auth*
*Completed: 2026-02-17*
