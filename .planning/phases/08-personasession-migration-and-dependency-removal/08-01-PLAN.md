---
phase: 08-personasession-migration-and-dependency-removal
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Packages/com.google.ai-embodiment/Runtime/AIEmbodimentSettings.cs
  - Packages/com.google.ai-embodiment/Editor/AIEmbodimentSettingsEditor.cs
  - Packages/com.google.ai-embodiment/Runtime/com.google.ai-embodiment.asmdef
  - Packages/com.google.ai-embodiment/Runtime/SystemInstructionBuilder.cs
  - Packages/com.google.ai-embodiment/Runtime/FunctionRegistry.cs
  - Packages/com.google.ai-embodiment/Runtime/ChirpTTSClient.cs
  - Assets/AyaLiveStream/AyaSampleController.cs
  - Assets/AyaLiveStream/AyaLiveStream.asmdef
  - Packages/com.google.ai-embodiment/Samples~/AyaLiveStream/AyaSampleController.cs
  - Packages/com.google.ai-embodiment/Samples~/AyaLiveStream/AyaLiveStream.asmdef
autonomous: true

must_haves:
  truths:
    - "Project compiles with zero Firebase.AI references in runtime source and asmdef files"
    - "AIEmbodimentSettings asset can be created via Assets > Create > AI Embodiment > Settings"
    - "API key field is password-masked in Inspector with reveal toggle"
    - "SystemInstructionBuilder returns string instead of ModelContent"
    - "FunctionRegistry compiles without FunctionDeclaration/Tool Firebase types"
    - "ChirpTTSClient uses Newtonsoft.Json instead of MiniJSON"
    - "Sample scene compiles with function registration stubbed out"
  artifacts:
    - path: "Packages/com.google.ai-embodiment/Runtime/AIEmbodimentSettings.cs"
      provides: "ScriptableObject singleton for API key via Resources.Load"
      contains: "Resources.Load<AIEmbodimentSettings>"
    - path: "Packages/com.google.ai-embodiment/Editor/AIEmbodimentSettingsEditor.cs"
      provides: "Custom inspector with password-masked API key field"
      contains: "PasswordField"
    - path: "Packages/com.google.ai-embodiment/Runtime/com.google.ai-embodiment.asmdef"
      provides: "Runtime assembly without Firebase.AI reference"
    - path: "Packages/com.google.ai-embodiment/Runtime/ChirpTTSClient.cs"
      provides: "TTS client using Newtonsoft.Json for serialization"
      contains: "JObject"
  key_links:
    - from: "AIEmbodimentSettings.cs"
      to: "Resources folder"
      via: "Resources.Load singleton pattern"
      pattern: "Resources\\.Load<AIEmbodimentSettings>"
    - from: "ChirpTTSClient.cs"
      to: "Newtonsoft.Json"
      via: "JObject for request/response serialization"
      pattern: "JObject"
---

<objective>
Remove all Firebase dependencies and create the AIEmbodimentSettings asset that replaces Firebase's API key source.

Purpose: Eliminate Firebase.AI from the project so PersonaSession can be rewired to GeminiLiveClient in Plan 02. Every file that references Firebase types must be cleaned up or stubbed so the project compiles at the end of this plan.

Output: Zero Firebase references in runtime code, new AIEmbodimentSettings ScriptableObject with password-masked editor, all supporting files migrated (SystemInstructionBuilder returns string, FunctionRegistry stubbed, ChirpTTSClient uses Newtonsoft, sample scene stubbed).
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-personasession-migration-and-dependency-removal/08-CONTEXT.md
@.planning/phases/08-personasession-migration-and-dependency-removal/08-RESEARCH.md
@Packages/com.google.ai-embodiment/Runtime/com.google.ai-embodiment.asmdef
@Packages/com.google.ai-embodiment/Runtime/SystemInstructionBuilder.cs
@Packages/com.google.ai-embodiment/Runtime/FunctionRegistry.cs
@Packages/com.google.ai-embodiment/Runtime/ChirpTTSClient.cs
@Packages/com.google.ai-embodiment/Runtime/PersonaConfig.cs
@Packages/com.google.ai-embodiment/Editor/com.google.ai-embodiment.editor.asmdef
@Assets/AyaLiveStream/AyaSampleController.cs
@Assets/AyaLiveStream/AyaLiveStream.asmdef
</context>

<tasks>

<task type="auto">
  <name>Task 1: Delete Firebase directories, create AIEmbodimentSettings, clean asmdef files</name>
  <files>
    Assets/Firebase/ (DELETE entire directory)
    Assets/ExternalDependencyManager/ (DELETE entire directory)
    Packages/com.google.ai-embodiment/Runtime/AIEmbodimentSettings.cs (CREATE)
    Packages/com.google.ai-embodiment/Runtime/AIEmbodimentSettings.cs.meta (CREATE - Unity will auto-generate, but commit whatever exists)
    Packages/com.google.ai-embodiment/Editor/AIEmbodimentSettingsEditor.cs (CREATE)
    Packages/com.google.ai-embodiment/Runtime/com.google.ai-embodiment.asmdef (MODIFY)
    Assets/AyaLiveStream/AyaLiveStream.asmdef (MODIFY)
    Packages/com.google.ai-embodiment/Samples~/AyaLiveStream/AyaLiveStream.asmdef (MODIFY)
  </files>
  <action>
    **Step 1: Delete Firebase directories**
    - `rm -rf Assets/Firebase/` (119 files -- SDK source, DLLs, Android m2repository, meta files)
    - `rm -rf Assets/ExternalDependencyManager/` (30 files -- Firebase companion dependency manager)
    - Search the entire project for any other Firebase references: `grep -r "Firebase" --include="*.cs" --include="*.asmdef" --include="*.json"` and address any found outside the known files

    **Step 2: Remove Firebase.AI from all asmdef files**
    - `com.google.ai-embodiment.asmdef`: Remove `"Firebase.AI"` from references array. The references array should become empty `[]` (Newtonsoft.Json is auto-referenced via the Unity package, not asmdef reference).
    - `Assets/AyaLiveStream/AyaLiveStream.asmdef`: Remove `"Firebase.AI"` from references array. Keep `"com.google.ai-embodiment"` and `"Unity.InputSystem"`.
    - `Packages/.../Samples~/AyaLiveStream/AyaLiveStream.asmdef`: Same change -- remove `"Firebase.AI"`, keep the other two references.

    **Step 3: Create AIEmbodimentSettings.cs**
    Create `Packages/com.google.ai-embodiment/Runtime/AIEmbodimentSettings.cs` with:
    - Namespace: `AIEmbodiment`
    - Class: `AIEmbodimentSettings : ScriptableObject`
    - `[CreateAssetMenu(fileName = "AIEmbodimentSettings", menuName = "AI Embodiment/Settings")]`
    - Private const `ResourcePath = "AIEmbodimentSettings"`
    - `[SerializeField] private string _apiKey = ""`
    - Public property `ApiKey => _apiKey`
    - Static `_instance` field with `Instance` property that does `Resources.Load<AIEmbodimentSettings>(ResourcePath)` with null-caching
    - See 08-RESEARCH.md "AIEmbodimentSettings Implementation" code example for exact implementation

    **Step 4: Create AIEmbodimentSettingsEditor.cs**
    Create `Packages/com.google.ai-embodiment/Editor/AIEmbodimentSettingsEditor.cs` with:
    - Namespace: `AIEmbodiment.Editor`
    - `[CustomEditor(typeof(AIEmbodimentSettings))]`
    - Class: `AIEmbodimentSettingsEditor : UnityEditor.Editor`
    - SerializedProperty `_apiKey` found via `FindProperty("_apiKey")`
    - Bool `_showApiKey` toggle
    - `OnInspectorGUI`: When `_showApiKey` is false, use `EditorGUILayout.PasswordField`; when true, use `EditorGUILayout.PropertyField`. Show/Hide button via `GUILayout.Button`.
    - HelpBox warning when API key is empty: "API key is required. Get one from Google AI Studio: https://aistudio.google.com/apikey"
    - See 08-RESEARCH.md "AIEmbodimentSettings Editor" code example for exact implementation
  </action>
  <verify>
    - `find Assets/Firebase/ -type f 2>/dev/null | wc -l` returns 0
    - `find Assets/ExternalDependencyManager/ -type f 2>/dev/null | wc -l` returns 0
    - `grep -r "Firebase" Packages/com.google.ai-embodiment/ --include="*.asmdef"` returns no matches
    - `grep -r "Firebase" Assets/AyaLiveStream/ --include="*.asmdef"` returns no matches
    - AIEmbodimentSettings.cs exists and contains `Resources.Load<AIEmbodimentSettings>`
    - AIEmbodimentSettingsEditor.cs exists and contains `PasswordField`
  </verify>
  <done>Firebase directories deleted, all asmdef files cleaned of Firebase.AI references, AIEmbodimentSettings ScriptableObject and its custom editor created</done>
</task>

<task type="auto">
  <name>Task 2: Migrate SystemInstructionBuilder, FunctionRegistry, ChirpTTSClient, and sample scene</name>
  <files>
    Packages/com.google.ai-embodiment/Runtime/SystemInstructionBuilder.cs (MODIFY)
    Packages/com.google.ai-embodiment/Runtime/FunctionRegistry.cs (MODIFY)
    Packages/com.google.ai-embodiment/Runtime/ChirpTTSClient.cs (MODIFY)
    Assets/AyaLiveStream/AyaSampleController.cs (MODIFY)
    Packages/com.google.ai-embodiment/Samples~/AyaLiveStream/AyaSampleController.cs (MODIFY)
  </files>
  <action>
    **Step 1: Migrate SystemInstructionBuilder.cs**
    - Remove `using Firebase.AI;`
    - Change `public static ModelContent Build(PersonaConfig config)` to `public static string Build(PersonaConfig config)` -- return `BuildInstructionText(config)` directly instead of wrapping in `ModelContent.Text()`
    - Change `public static ModelContent Build(PersonaConfig config, GoalManager goalManager)` to `public static string Build(PersonaConfig config, GoalManager goalManager)` -- return `BuildInstructionText(config, goalManager)` directly
    - Update XML doc comments to reference `string` instead of `ModelContent`
    - The two `BuildInstructionText` internal methods remain unchanged (they already return string)

    **Step 2: Migrate FunctionRegistry.cs**
    - Remove `using Firebase.AI;`
    - Remove `using System.Linq;` (only needed for `.Select()` in BuildTools)
    - Change the storage dictionary from `Dictionary<string, (FunctionDeclaration declaration, FunctionHandler handler)>` to `Dictionary<string, FunctionHandler>` (drop declaration storage entirely)
    - Change `Register(string name, FunctionDeclaration declaration, FunctionHandler handler)` to `Register(string name, FunctionHandler handler)`. Add comment: `// TODO: Phase 10 -- add function declaration parameter back with WebSocket-native type (JObject schema)`
    - Remove `BuildTools()` method entirely. Add comment in its place: `// TODO: Phase 10 -- BuildToolsJson() returns JArray of tool declarations for WebSocket setup`
    - Change `HasRegistrations` to use `_entries.Count > 0` (still works, `_entries` is now `Dictionary<string, FunctionHandler>`)
    - `TryGetHandler`: Simplify to `_entries.TryGetValue(functionName, out handler)` (no more tuple destructuring)
    - Keep `MarkCancelled`, `IsCancelled`, `Freeze()` method, and `_frozen` check unchanged
    - Update XML doc comments to remove Firebase type references

    **Step 3: Migrate ChirpTTSClient.cs**
    - Remove `using Google.MiniJSON;`
    - Add `using Newtonsoft.Json;` and `using Newtonsoft.Json.Linq;`
    - In `BuildRequestJson`: Replace `Json.Serialize(requestBody)` with building a `JObject` directly. Build the request using nested JObject construction:
      ```
      var obj = new JObject();
      var input = new JObject();
      if (isCustomVoice) input["text"] = text;
      else input["ssml"] = $"<speak>{text}</speak>";
      obj["input"] = input;
      // ... voice and audioConfig similarly
      return obj.ToString(Formatting.None);
      ```
      This is cleaner than building Dictionary then serializing. See 08-RESEARCH.md "ChirpTTSClient MiniJSON -> Newtonsoft Migration" for the pattern.
    - In `ExtractAudioContent`: Replace `Json.Deserialize(responseJson) is Dictionary<string, object>` with `JObject.Parse(responseJson)`. Extract: `var response = JObject.Parse(responseJson); return response["audioContent"]?.ToString();`
    - Update the XML doc comment on `BuildRequestJson` to say "Newtonsoft.Json" instead of "MiniJSON"
    - Update the doc comment on the constructor to say `AIEmbodimentSettings.Instance.ApiKey` instead of `Firebase.FirebaseApp.DefaultInstance.Options.ApiKey`

    **Step 4: Stub AyaSampleController.cs (BOTH locations)**
    Both `Assets/AyaLiveStream/AyaSampleController.cs` and `Packages/.../Samples~/AyaLiveStream/AyaSampleController.cs` must be updated identically:
    - Remove `using Firebase.AI;`
    - Comment out the entire body of `RegisterFunctions()` with `// TODO: Phase 10 -- restore function registration with WebSocket-native types`
    - Change the three `_session.RegisterFunction("name", new FunctionDeclaration(...), handler)` calls to `_session.RegisterFunction("name", handler)` -- this matches the new 2-parameter Register signature. Keep the handler implementations (HandleEmote, HandleStartMovie, HandleStartDrawing) unchanged since they don't use Firebase types.
    - Wait -- actually, the function handlers are still useful and work fine. The only issue is FunctionDeclaration. Since we're removing the declaration parameter from Register(), just change the calls to the 2-parameter form. The functions will be registered (handlers available for dispatch) but won't have declarations sent to Gemini (that's Phase 10's job).

    **Step 5: Temporarily stub PersonaSession.cs Firebase references for compilation**
    PersonaSession.cs has many Firebase references that Plan 02 will fully rewrite. To ensure this plan leaves the project compilable, add minimal stubs:
    - Remove `using Firebase.AI;`
    - Comment out the bodies of `Connect()`, `SendText()`, `HandleAudioCaptured()`, `SendFunctionResponseAsync()`, `SendGoalUpdate()`, `ReceiveLoopAsync()`, and `ProcessResponse()` with `// TODO: Plan 08-02 will fully rewrite this method`
    - Remove `private LiveSession _liveSession;` field declaration
    - Keep all public event declarations, public method signatures, and the class structure intact
    - Add `private GeminiLiveClient _client;` as a placeholder field (Plan 02 will use it)
    - Keep Disconnect() and OnDestroy() but replace `_liveSession` references with `_client` references using `_client?.Disconnect()` / `_client?.Dispose()` patterns
    - The RegisterFunction call must be updated to match the new 2-parameter FunctionRegistry.Register: change `_functionRegistry.Register(name, declaration, handler)` to `_functionRegistry.Register(name, handler)` and update the public `RegisterFunction` signature to `RegisterFunction(string name, FunctionHandler handler)` with a `// TODO: Phase 10` comment

    This ensures the project compiles at the end of Task 2 even though PersonaSession is non-functional until Plan 02 completes the rewrite.
  </action>
  <verify>
    - `grep -rn "using Firebase" Packages/com.google.ai-embodiment/Runtime/ --include="*.cs"` returns no matches
    - `grep -rn "using Firebase" Assets/AyaLiveStream/ --include="*.cs"` returns no matches
    - `grep -rn "using Google.MiniJSON" Packages/com.google.ai-embodiment/ --include="*.cs"` returns no matches
    - `grep -rn "ModelContent" Packages/com.google.ai-embodiment/Runtime/SystemInstructionBuilder.cs` returns no matches
    - `grep -rn "FunctionDeclaration\|BuildTools\|Tool\[" Packages/com.google.ai-embodiment/Runtime/FunctionRegistry.cs` returns no matches
    - `grep -rn "Json\.Serialize\|Json\.Deserialize" Packages/com.google.ai-embodiment/Runtime/ChirpTTSClient.cs` returns no matches
    - `grep -rn "LiveSession\|FirebaseAI\|ModelContent" Packages/com.google.ai-embodiment/Runtime/PersonaSession.cs` returns no matches
    - All .cs files in the runtime package have no Firebase type references
  </verify>
  <done>All Firebase type references eliminated from runtime code. SystemInstructionBuilder returns string. FunctionRegistry uses handler-only registration. ChirpTTSClient uses Newtonsoft.Json. Sample scene function registration updated. PersonaSession stubbed for compilation. Project has zero Firebase.AI dependencies.</done>
</task>

</tasks>

<verification>
1. `grep -rn "Firebase" Packages/com.google.ai-embodiment/ --include="*.cs" --include="*.asmdef"` returns zero matches
2. `grep -rn "Firebase" Assets/AyaLiveStream/ --include="*.cs" --include="*.asmdef"` returns zero matches
3. `grep -rn "Google.MiniJSON" Packages/com.google.ai-embodiment/ --include="*.cs"` returns zero matches
4. `find Assets/Firebase/ -type f 2>/dev/null | wc -l` returns 0
5. `find Assets/ExternalDependencyManager/ -type f 2>/dev/null | wc -l` returns 0
6. AIEmbodimentSettings.cs contains `Resources.Load`, `CreateAssetMenu`, `ApiKey` property
7. AIEmbodimentSettingsEditor.cs contains `PasswordField`, `CustomEditor`
</verification>

<success_criteria>
- Zero Firebase.AI references anywhere in the project runtime code and asmdef files
- Assets/Firebase/ and Assets/ExternalDependencyManager/ directories deleted
- AIEmbodimentSettings ScriptableObject exists with API key property and Resources.Load singleton
- Custom editor shows password-masked API key field with reveal toggle
- SystemInstructionBuilder.Build() returns string (not ModelContent)
- FunctionRegistry.Register() takes (name, handler) without FunctionDeclaration parameter
- ChirpTTSClient uses Newtonsoft.Json JObject for request building and response parsing
- AyaSampleController uses 2-parameter RegisterFunction calls
- PersonaSession is stubbed to compile (non-functional until Plan 02)
</success_criteria>

<output>
After completion, create `.planning/phases/08-personasession-migration-and-dependency-removal/08-01-SUMMARY.md`
</output>
