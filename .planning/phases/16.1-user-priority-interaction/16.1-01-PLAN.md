---
phase: 16.1-user-priority-interaction
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Assets/AyaLiveStream/LivestreamController.cs
  - Assets/AyaLiveStream/NarrativeDirector.cs
  - Assets/AyaLiveStream/Data/Beat_WarmUp.asset
  - Assets/AyaLiveStream/Data/Beat_ArtProcess.asset
  - Assets/AyaLiveStream/Data/Beat_Characters.asset
autonomous: true

must_haves:
  truths:
    - "Aya greets viewers on connection and then focuses on drawing activity rather than driving narrative"
    - "User PTT input is always prioritized -- Aya responds to user messages before any bot messages in AyaChecksChat"
    - "Aya only responds to bot chat messages if the user has not spoken via PTT within 2 minutes"
    - "The 2-minute user silence timer resets each time the user speaks via PTT"
  artifacts:
    - path: "Assets/AyaLiveStream/LivestreamController.cs"
      provides: "User silence timer with _lastUserSpeechTime, _userSilenceThreshold (120f), OnUserSpeakingStopped subscription, Func<bool> injection into NarrativeDirector"
      contains: "_userSilenceThreshold"
    - path: "Assets/AyaLiveStream/NarrativeDirector.cs"
      provides: "SetUserSilenceProvider(Func<bool>) setter, gated bot message injection in ExecuteAyaChecksChat"
      contains: "SetUserSilenceProvider"
    - path: "Assets/AyaLiveStream/Data/Beat_WarmUp.asset"
      provides: "Drawing-focused director note for warm-up beat"
      contains: "settle into your drawing"
    - path: "Assets/AyaLiveStream/Data/Beat_ArtProcess.asset"
      provides: "Drawing-focused director note for art process beat"
      contains: "focused on your art"
    - path: "Assets/AyaLiveStream/Data/Beat_Characters.asset"
      provides: "User-responsive director note for characters beat"
      contains: "engage with them"
  key_links:
    - from: "Assets/AyaLiveStream/LivestreamController.cs"
      to: "Assets/AyaLiveStream/NarrativeDirector.cs"
      via: "SetUserSilenceProvider(Func<bool>) call in Start()"
      pattern: "SetUserSilenceProvider\\("
    - from: "Assets/AyaLiveStream/LivestreamController.cs"
      to: "PersonaSession.OnUserSpeakingStopped"
      via: "Event subscription for timer reset"
      pattern: "OnUserSpeakingStopped"
    - from: "Assets/AyaLiveStream/NarrativeDirector.cs"
      to: "_isUserSilent callback"
      via: "Gate in ExecuteAyaChecksChat that skips bot messages when user is active"
      pattern: "_isUserSilent.*\\(\\)"
---

<objective>
Add user-priority interaction to the livestream experience. Aya greets viewers and focuses on drawing, only responding to bot messages after 2 minutes of user silence via PTT. User messages always take priority.

Purpose: The current experience has Aya constantly responding to scripted bot chatter, making the user feel like a spectator. This shifts Aya to be user-focused -- she draws, responds eagerly when the user speaks, and only engages bots as a fallback for dead air.

Output: Modified LivestreamController (user silence timer), modified NarrativeDirector (gated bot injection), and reframed beat asset director notes.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16.1-user-priority-interaction/16.1-RESEARCH.md

# Source files being modified:
@Assets/AyaLiveStream/LivestreamController.cs
@Assets/AyaLiveStream/NarrativeDirector.cs
@Assets/AyaLiveStream/Data/Beat_WarmUp.asset
@Assets/AyaLiveStream/Data/Beat_ArtProcess.asset
@Assets/AyaLiveStream/Data/Beat_Characters.asset
</context>

<tasks>

<task type="auto">
  <name>Task 1: User silence timer and gated bot injection</name>
  <files>
    Assets/AyaLiveStream/LivestreamController.cs
    Assets/AyaLiveStream/NarrativeDirector.cs
  </files>
  <action>
    **LivestreamController.cs modifications:**

    1. Add a new `[Header("User Priority")]` section after the existing Configuration header with:
       - `[SerializeField] private float _userSilenceThreshold = 120f;` (2 minutes default)

    2. Add private field: `private float _lastUserSpeechTime;`

    3. Add a named event handler field alongside the existing ones (line ~52 area):
       `private Action _onUserSpeakingStopped;`

    4. In `Start()`, AFTER the existing event subscriptions block (after line 84) and BEFORE the narrative completion subscription (line 87), add:
       ```
       // User priority: track when user last spoke via PTT
       _lastUserSpeechTime = Time.time;
       _onUserSpeakingStopped = () => { _lastUserSpeechTime = Time.time; };
       if (_session != null)
       {
           _session.OnUserSpeakingStopped += _onUserSpeakingStopped;
       }

       // Inject user silence check into NarrativeDirector
       _narrativeDirector?.SetUserSilenceProvider(
           () => Time.time - _lastUserSpeechTime >= _userSilenceThreshold);
       ```

    5. In `OnDestroy()`, inside the existing `if (_session != null)` block (after line 295), add:
       ```
       if (_onUserSpeakingStopped != null)
           _session.OnUserSpeakingStopped -= _onUserSpeakingStopped;
       ```

    IMPORTANT: Initialize `_lastUserSpeechTime = Time.time` (NOT 0 or float.MinValue). This ensures the user silence timer starts from experience start, giving the user 2 minutes to engage before Aya starts responding to bots. See Pitfall 1 in RESEARCH.md.

    **NarrativeDirector.cs modifications:**

    1. Add private field (after line 78, near the FactTracker field):
       `private Func<bool> _isUserSilent;`

    2. Add public setter method (after the existing `SetFactTracker` method, around line 140):
       ```
       /// <summary>
       /// Injects a callback that returns true when the user has been silent
       /// long enough that Aya should engage with bot messages. When the callback
       /// returns false, AyaChecksChat skips bot messages and only processes
       /// user messages. Called by LivestreamController in Start().
       /// </summary>
       public void SetUserSilenceProvider(Func<bool> isUserSilent)
       {
           _isUserSilent = isUserSilent;
       }
       ```

    3. In `ExecuteAyaChecksChat`, replace the message selection logic on line 417:
       ```
       // BEFORE (line 417):
       var toAddress = userMessages.Count > 0 ? userMessages : botMessages;

       // AFTER:
       List<TrackedChatMessage> toAddress;
       if (userMessages.Count > 0)
       {
           // User messages always get through (user priority)
           toAddress = userMessages;
       }
       else if (_isUserSilent == null || _isUserSilent())
       {
           // No user silence provider, or user has been silent for threshold -- bots can get attention
           toAddress = botMessages;
       }
       else
       {
           // User is active (or recently active) and no user messages queued.
           // Skip bot messages -- Aya stays focused on drawing.
           Debug.Log($"[NarrativeDirector] AyaChecksChat '{scene.sceneId}': " +
                     "user recently active, skipping bot messages");
           return;
       }
       ```

    IMPORTANT: The `_isUserSilent == null` fallback ensures backward compatibility -- if no provider is set (e.g., in tests or standalone NarrativeDirector), the old behavior (always process bot messages) is preserved.

    IMPORTANT: Do NOT gate AyaDialogue scenes. Only AyaChecksChat bot injection is gated. AyaDialogue scenes still fire director notes normally so the narrative progresses. See Pitfall 5 and Open Question 2 in RESEARCH.md.

    IMPORTANT: Do NOT modify PushToTalkController or ChatBotManager. PTT already fires the correct events. Bots keep posting for ambiance. See Anti-Patterns in RESEARCH.md.
  </action>
  <verify>
    1. `grep -n "_userSilenceThreshold" Assets/AyaLiveStream/LivestreamController.cs` shows the SerializeField declaration
    2. `grep -n "SetUserSilenceProvider" Assets/AyaLiveStream/LivestreamController.cs` shows the injection call in Start()
    3. `grep -n "SetUserSilenceProvider" Assets/AyaLiveStream/NarrativeDirector.cs` shows the public setter method
    4. `grep -n "_isUserSilent" Assets/AyaLiveStream/NarrativeDirector.cs` shows the field and the gate in ExecuteAyaChecksChat
    5. `grep -n "OnUserSpeakingStopped" Assets/AyaLiveStream/LivestreamController.cs` shows both subscribe and unsubscribe
    6. `grep -n "_lastUserSpeechTime = Time.time" Assets/AyaLiveStream/LivestreamController.cs` shows correct initialization (NOT 0)
    7. Verify NarrativeDirector.ExecuteAyaChecksChat has the three-way conditional (user messages -> silent bots -> skip) instead of the simple ternary
    8. Verify PushToTalkController.cs and ChatBotManager.cs are NOT modified (diff should be clean for those files)
  </verify>
  <done>
    LivestreamController tracks user silence via OnUserSpeakingStopped event, initialized to Time.time, with configurable threshold (default 120s). NarrativeDirector gates bot message injection in ExecuteAyaChecksChat behind the user silence callback. User messages always pass through. Bot messages only pass when the user has been silent for 2+ minutes. Both subscribe and unsubscribe paths are clean.
  </done>
</task>

<task type="auto">
  <name>Task 2: Reframe beat director notes for drawing focus</name>
  <files>
    Assets/AyaLiveStream/Data/Beat_WarmUp.asset
    Assets/AyaLiveStream/Data/Beat_ArtProcess.asset
    Assets/AyaLiveStream/Data/Beat_Characters.asset
  </files>
  <action>
    Modify the `directorNote` field in each beat .asset file (YAML format). The tone shifts from "drive conversation" to "focus on your art, engage when spoken to." The beat structure, scenes, and all other fields remain UNCHANGED.

    IMPORTANT: These are Unity YAML .asset files. Single quotes in YAML strings must be escaped as double single quotes (''). Preserve the exact YAML formatting (indentation, line breaks within the string value). Only modify the `directorNote:` value.

    **Beat_WarmUp.asset** -- Replace the `directorNote:` value with:
    ```
    [Director: You're just starting your art livestream. Greet your audience warmly, introduce yourself as Aya, and mention what you're working on today. Then settle into your drawing -- your main focus is creating art. Talk about your process occasionally, but don't force conversation. If a viewer speaks to you directly, engage with them enthusiastically and give them your full attention. Between viewer interactions, you can comment on your art, hum, or think aloud naturally. Let the viewer drive the chat.]
    ```

    **Beat_ArtProcess.asset** -- Replace the `directorNote:` value with:
    ```
    [Director: You're deep in your creative flow, focused on your art. Share thoughts about your tools and techniques when it feels natural, but your primary activity is drawing. You're working on character designs that are very close to your heart. If a viewer asks you about your process or characters, light up and engage fully. Between viewer interactions, stay focused on drawing -- occasional comments about what you're doing are fine, but don't monologue.]
    ```

    **Beat_Characters.asset** -- Replace the `directorNote:` value with:
    ```
    [Director: You're still focused on your drawing, but the characters you're working on have a deeper story. If a viewer asks about the characters or the story behind them, share passionately -- one character in particular has a story that's very personal to you. You've also been working on a short film that brings this character to life. Share these details when prompted by viewers or when it feels natural in your creative flow, but don't rush to reveal everything. Let the conversation build organically. If a viewer asks directly about the film or a reveal, build excitement.]
    ```

    For each .asset file:
    1. Read the current file
    2. Replace ONLY the `directorNote:` field value (the string after `directorNote:`)
    3. Escape all single quotes as '' (double single quotes) per YAML convention
    4. Preserve the exact indentation (2 spaces for continuation lines, matching existing format)
    5. Leave ALL other fields unchanged (beatId, title, timeBudgetSeconds, urgency, scenes, etc.)
  </action>
  <verify>
    1. `grep "settle into your drawing" Assets/AyaLiveStream/Data/Beat_WarmUp.asset` confirms new warm-up note
    2. `grep "focused on your art" Assets/AyaLiveStream/Data/Beat_ArtProcess.asset` confirms new art process note
    3. `grep "still focused on your drawing" Assets/AyaLiveStream/Data/Beat_Characters.asset` confirms new characters note
    4. `grep "Let the viewer drive" Assets/AyaLiveStream/Data/Beat_WarmUp.asset` confirms user-priority framing
    5. Verify each .asset file is valid YAML (no broken quotes, no missing fields)
    6. Verify beatId, timeBudgetSeconds, urgency, scenes, catalystMessages, skipKeywords, topicKeywords are ALL unchanged in each file (diff should only show directorNote changes)
  </verify>
  <done>
    All three beat director notes are reframed from "drive conversation" to "focus on drawing, engage when prompted." Warm-up tells Aya to greet then settle into drawing. Art Process tells Aya to stay in creative flow and engage when asked. Characters tells Aya to share the deeper story when prompted, building organically toward the reveal. The narrative arc progresses via the same beat structure, but the tone is user-responsive rather than Aya-driven.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. **Code correctness**: LivestreamController has _userSilenceThreshold (120f), _lastUserSpeechTime initialized to Time.time, OnUserSpeakingStopped subscription+unsubscription, and SetUserSilenceProvider injection call
2. **Gate correctness**: NarrativeDirector.ExecuteAyaChecksChat has three-way conditional: user messages always pass, bot messages only pass when _isUserSilent() returns true, otherwise early return with log
3. **Backward compatibility**: _isUserSilent == null falls back to old behavior (bot messages always processed)
4. **No unintended modifications**: PushToTalkController.cs, ChatBotManager.cs, LivestreamUI.cs are untouched
5. **Asset integrity**: Beat assets only have directorNote changes, all other fields preserved
6. **YAML validity**: No broken quotes or formatting in .asset files
7. **Clean unsubscription**: OnDestroy in LivestreamController properly removes OnUserSpeakingStopped handler
</verification>

<success_criteria>
- LivestreamController tracks user silence with configurable 2-minute threshold
- NarrativeDirector skips bot messages in AyaChecksChat when user has been active within 2 minutes
- User messages in AyaChecksChat always pass through regardless of timer state
- Beat director notes emphasize drawing focus and user-responsive engagement
- No modifications to PushToTalkController, ChatBotManager, or any other files
- All existing behavior preserved when no user silence provider is set (backward compatible)
</success_criteria>

<output>
After completion, create `.planning/phases/16.1-user-priority-interaction/16.1-01-SUMMARY.md`
</output>
