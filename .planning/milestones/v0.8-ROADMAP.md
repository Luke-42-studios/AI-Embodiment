# Milestone v0.8: WebSocket Migration

**Status:** SHIPPED 2026-02-17
**Phases:** 7-11.2
**Total Plans:** 14

## Overview

Replace Firebase AI Logic SDK with direct WebSocket client, support audio-only Gemini models, and introduce ITTSProvider abstraction for custom voice cloning. Same public API surface, zero Firebase dependency.

## Phases

### Phase 7: WebSocket Transport and Audio Parsing

**Goal**: A standalone GeminiLiveClient connects to Gemini Live over WebSocket, sends/receives audio, and exposes all server events via a thread-safe event queue
**Depends on**: Nothing (foundation phase)
**Requirements**: WS-01, WS-02, WS-03, WS-04, WS-05, AUD-01, AUD-02, AUD-03, AUD-04, AUD-05
**Plans**: 2 plans

Plans:
- [x] 07-01-PLAN.md -- GeminiLiveClient core: data types (GeminiEvent, GeminiLiveConfig), WebSocket connect, setup handshake, send methods (SendAudio, SendText), disconnect, ConcurrentQueue event infrastructure, Newtonsoft.Json dependency
- [x] 07-02-PLAN.md -- Receive loop and event dispatch: multi-frame message accumulation, JSON type dispatch, audio decoding (base64 -> PCM -> float[]), transcription extraction, turn lifecycle events, function call event parsing

### Phase 8: PersonaSession Migration and Dependency Removal

**Goal**: PersonaSession uses GeminiLiveClient instead of Firebase LiveSession, all Firebase references are removed, and existing public API (events, methods, properties) works identically
**Depends on**: Phase 7
**Requirements**: MIG-01, MIG-02, MIG-03, MIG-06, DEP-01, DEP-02, DEP-03, DEP-04
**Plans**: 2 plans

Plans:
- [x] 08-01-PLAN.md -- Firebase purge and dependency swap: delete Firebase/ExternalDependencyManager directories, create AIEmbodimentSettings ScriptableObject with password-masked editor, clean all asmdef files, migrate SystemInstructionBuilder to return string, stub FunctionRegistry without Firebase types, migrate ChirpTTSClient from MiniJSON to Newtonsoft.Json, stub sample scene
- [x] 08-02-PLAN.md -- PersonaSession rewire: replace LiveSession with GeminiLiveClient, rewrite Connect/Disconnect/SendText/HandleAudioCaptured, implement HandleGeminiEvent event bridge with complete GeminiEventType-to-public-event mapping, add FloatToPcm16 audio conversion, ProcessEvents polling in Update

### Phase 9: TTS Abstraction

**Goal**: Developers can choose between Gemini native audio and custom TTS backends via a clean ITTSProvider interface, with ChirpTTSClient as the shipped implementation
**Depends on**: Phase 8
**Requirements**: TTS-01, TTS-02, TTS-03, TTS-04
**Plans**: 2 plans

Plans:
- [x] 09-01-PLAN.md -- ITTSProvider interface + TTSResult struct + TTSSynthesisMode enum, VoiceBackend.Custom, ChirpTTSClient implements ITTSProvider, PersonaConfig field renames
- [x] 09-02-PLAN.md -- PersonaSession provider-agnostic TTS routing, SetTTSProvider API, PersonaConfigEditor Custom backend UI

### Phase 10: Function Calling and Goals Migration

**Goal**: AI-triggered function calls and conversational goals work over the WebSocket transport with the same developer-facing API, including both native toolCall and prompt-based fallback paths
**Depends on**: Phase 8
**Requirements**: MIG-04, MIG-05
**Plans**: 2 plans

Plans:
- [x] 10-01-PLAN.md -- Function calling infrastructure: FunctionDeclaration builder, FunctionRegistry declaration support with dual-path output, GeminiEvent FunctionId, GeminiLiveConfig ToolsJson, GeminiLiveClient tools in setup + SendToolResponse + toolCallCancellation parsing
- [x] 10-02-PLAN.md -- PersonaSession wiring: RegisterFunction with declaration, function call ID flow, toolResponse sending, prompt-based fallback parsing, FunctionCallCancellation handling, SendGoalUpdate finalization

### Phase 11: Integration Verification

**Goal**: The complete v0.8 package works end-to-end in the sample scene with both voice backends
**Depends on**: Phase 9, Phase 10
**Requirements**: INT-01, INT-02
**Plans**: 2 plans

Plans:
- [x] 11-01-PLAN.md -- Infrastructure fixes: create missing .meta files for v0.8 source files, create AIEmbodimentSettings asset in Resources, fix scene YAML (AudioPlayback._audioSource wiring, PlayOnAwake)
- [x] 11-02-PLAN.md -- AyaSampleController status feedback and SyncPacket validation logging, Samples~ sync, end-to-end human verification

### Phase 11.1: Queued Response Sample (INSERTED)

**Goal**: A new sample scene demonstrating a push-to-talk transcript-approve-then-play UX where the user holds spacebar to speak, sees their transcript, approves with Enter, and the AI response (pre-fetched in background) plays back immediately
**Depends on**: Phase 11
**Plans**: 2 plans

Plans:
- [x] 11.1-01-PLAN.md -- Project structure, UI assets (UXML/USS), QueuedResponseController state machine with audio buffering, QueuedResponseUI with state-driven display
- [x] 11.1-02-PLAN.md -- Samples~ sync and end-to-end human verification of the queued response UX

### Phase 11.2: Chirp Custom Voice Bearer Auth (INSERTED)

**Goal**: ChirpTTSClient authenticates with Google Cloud TTS via OAuth2 bearer tokens (service account JWT exchange) instead of API key, enabling Chirp Custom Voice cloning on the v1beta1 endpoint
**Depends on**: Phase 11.1
**Plans**: 2 plans

Plans:
- [x] 11.2-01-PLAN.md -- GoogleServiceAccountAuth credential provider (JWT signing, token exchange, caching), AIEmbodimentSettings service account path field, editor UI file picker, .gitignore updates
- [x] 11.2-02-PLAN.md -- ChirpTTSClient dual-auth (API key v1 / bearer token v1beta1), PersonaSession service account lifecycle and auth-aware TTS provider creation

---

## Milestone Summary

**Decimal Phases:**
- Phase 11.1: Queued Response Sample (inserted after Phase 11 for push-to-talk UX demo)
- Phase 11.2: Chirp Custom Voice Bearer Auth (inserted after Phase 11.1 for OAuth2 service account auth)

**Key Decisions:**
- Direct WebSocket to Gemini Live (replacing Firebase AI Logic SDK)
- Newtonsoft.Json replaces MiniJSON for serialization
- Audio-only Gemini models (gemini-2.5-flash-native-audio) as successor to 2.0-flash
- API key in AIEmbodimentSettings ScriptableObject (Resources.Load singleton)
- ITTSProvider interface for TTS backend abstraction
- Manual JWT RS256 signing (~200 lines) instead of Google.Apis.Auth NuGet dependency
- PersonaSession owns GoogleServiceAccountAuth lifetime (caller-owns pattern)
- UseNativeFunctionCalling=false as production default (prompt-based function calling)

**Issues Resolved:**
- Firebase 149-file purge completed cleanly with asmdef dependency rewiring
- Audio streaming bugs (ring buffer overflow, watermark tuning, re-buffering underrun) fixed during integration verification
- IsPlaying audio drain detection fixed during QueuedResponse human verification
- Output transcription replacement semantics corrected (was appending, needed replacing)

**Issues Deferred:**
- RSA.ImportPkcs8PrivateKey may fail on Android IL2CPP -- editor-only for now

**Technical Debt Incurred:**
- None significant

---

_For current project status, see .planning/ROADMAP.md_
